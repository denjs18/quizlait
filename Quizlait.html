<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quizlet Clone - RÃ©vision par Flashcards</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-analytics-compat.js"></script>
    <style>
        :root {
            --color-primary: #6366f1;
            --color-primary-hover: #4f46e5;
            --color-primary-active: #4338ca;
            --color-secondary: #8b5cf6;
            --color-success: #10b981;
            --color-danger: #ef4444;
            --color-warning: #f59e0b;
            --color-info: #06b6d4;
            --color-light: #f8fafc;
            --color-dark: #0f172a;
            --color-white: #ffffff;
            --color-border: #e2e8f0;
            --color-text: #1e293b;
            --color-text-light: #64748b;
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 12px rgba(99, 102, 241, 0.1);
            --shadow-lg: 0 12px 24px rgba(99, 102, 241, 0.15);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #f0f4f8 100%);
            color: var(--color-text);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ========== HEADER ========== */
        .header {
            background: var(--color-white);
            border-bottom: none;
            padding: 20px 0;
            margin-bottom: 40px;
            box-shadow: var(--shadow-md);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideDownFade 0.6s var(--transition);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            user-select: none;
        }

        .logo-pill {
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            padding: 6px 18px;
            border-radius: 14px;
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
            transition: var(--transition);
        }

        .logo-pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(99, 102, 241, 0.25);
        }

        .logo-emoji {
            font-size: 24px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .logo-text {
            font-size: 24px;
            font-weight: 800;
            letter-spacing: -0.5px;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        @keyframes slideDownFade {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        /* ========== BUTTONS ========== */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            color: var(--color-white);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        .btn-primary:active {
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: var(--color-secondary);
            color: var(--color-white);
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-success {
            background-color: var(--color-success);
            color: var(--color-white);
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-danger {
            background-color: var(--color-danger);
            color: var(--color-white);
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--color-primary);
            color: var(--color-primary);
        }

        .btn-outline:hover {
            background-color: var(--color-primary);
            color: var(--color-white);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ========== SCREENS ========== */
        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* ========== HOME SCREEN ========== */
        .home-screen {
            text-align: center;
        }

        .hero {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            color: var(--color-white);
            padding: 80px 40px;
            border-radius: var(--radius-lg);
            margin-bottom: 50px;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.8s var(--transition);
        }

        .hero::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }

        .hero::after {
            content: '';
            position: absolute;
            bottom: -50%;
            left: -50%;
            width: 150px;
            height: 150px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }

        .hero h1 {
            font-size: 56px;
            margin-bottom: 15px;
            font-weight: 800;
            position: relative;
            z-index: 1;
        }

        .hero p {
            font-size: 20px;
            margin-bottom: 30px;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hero-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .sets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }

        .set-card {
            background: var(--color-white);
            border-radius: var(--radius-lg);
            padding: 30px;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: var(--transition);
            text-align: left;
            border: 1px solid var(--color-border);
            animation: scaleIn 0.5s var(--transition);
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .set-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-lg);
            border-color: var(--color-primary);
        }

        .set-card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 10px;
        }

        .set-card-count {
            color: var(--color-text-light);
            font-size: 14px;
            margin-bottom: 15px;
        }

        .set-card-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-start;
        }

        .set-card-actions .btn {
            flex: 1;
            justify-content: center;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state p {
            color: var(--color-text-light);
            margin-bottom: 20px;
        }

        /* ========== CREATE/EDIT SET SCREEN ========== */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--color-text);
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(31, 151, 198, 0.1);
        }

        textarea.form-input {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .form-section {
            background: var(--color-white);
            border-radius: var(--radius-lg);
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
        }

        .form-section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--color-light);
        }

        .flashcard-input {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
            background: var(--color-light);
            padding: 15px;
            border-radius: var(--radius-md);
        }

        .flashcard-input input {
            padding: 10px;
        }

        .flashcard-input button {
            grid-column: 2;
        }

        @media (max-width: 768px) {
            .flashcard-input {
                grid-template-columns: 1fr;
            }

            .flashcard-input button {
                grid-column: 1;
            }
        }

        .add-card-btn {
            width: 100%;
            margin-bottom: 20px;
        }

        /* ========== STUDY MODE SCREEN ========== */
        .study-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: var(--color-white);
            padding: 20px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }

        .study-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-primary);
        }

        .study-progress {
            font-size: 14px;
            color: var(--color-text-light);
        }

        .study-mode-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .mode-btn {
            padding: 12px 20px;
            border: 2px solid var(--color-border);
            background: var(--color-white);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: var(--color-text);
        }

        .mode-btn.active {
            background: var(--color-primary);
            color: var(--color-white);
            border-color: var(--color-primary);
        }

        .mode-btn:hover {
            border-color: var(--color-primary);
            transform: translateY(-2px);
        }

        /* ========== FLASHCARD MODE ========== */
        .flashcard-container {
            perspective: 1000px;
            margin-bottom: 30px;
        }

        .flashcard {
            background: var(--color-white);
            border-radius: var(--radius-lg);
            padding: 60px 40px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            border: 1px solid var(--color-border);
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        .flashcard:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(99, 102, 241, 0.2);
        }

        .flashcard.flipped {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            color: var(--color-white);
        }

        .flashcard-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            opacity: 0.6;
            margin-bottom: 15px;
            letter-spacing: 1px;
        }

        .flashcard-content {
            font-size: 32px;
            font-weight: 600;
            word-wrap: break-word;
            max-width: 100%;
        }

        .flashcard-hint {
            font-size: 12px;
            margin-top: 20px;
            opacity: 0.7;
        }

        /* ========== PROGRESS STATS ========== */
        .progress-container {
            background: var(--color-white);
            border-radius: var(--radius-lg);
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: var(--shadow-md);
        }

        .progress-header {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 25px;
        }

        .progress-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .progress-stat {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
            padding: 20px;
            border-radius: var(--radius-md);
            border-left: 4px solid var(--color-primary);
            text-align: center;
        }

        .progress-stat-label {
            font-size: 12px;
            text-transform: uppercase;
            font-weight: 600;
            color: var(--color-text-light);
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .progress-stat-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--color-primary);
        }

        .progress-bar-container {
            width: 100%;
            height: 10px;
            background: var(--color-light);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            transition: width 0.5s ease;
        }

        .set-stats {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, rgba(139, 92, 246, 0.08) 100%);
            padding: 20px;
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border);
            margin-bottom: 15px;
        }

        .set-stats-title {
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 12px;
            font-size: 16px;
        }

        .set-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
        }

        .set-stat-item {
            text-align: center;
        }

        .set-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--color-primary);
        }

        .set-stat-label {
            font-size: 11px;
            color: var(--color-text-light);
            text-transform: uppercase;
            margin-top: 4px;
        }

        .flashcard-hint {
            font-size: 12px;
            margin-top: 20px;
            opacity: 0.7;
        }

        /* ========== PROGRESS STATS ========== */
        .progress-container {
            background: var(--color-white);
            border-radius: var(--radius-lg);
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: var(--shadow-md);
        }

        .progress-header {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 25px;
        }

        .progress-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .progress-stat {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
            padding: 20px;
            border-radius: var(--radius-md);
            border-left: 4px solid var(--color-primary);
            text-align: center;
        }

        .progress-stat-label {
            font-size: 12px;
            text-transform: uppercase;
            font-weight: 600;
            color: var(--color-text-light);
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .progress-stat-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--color-primary);
        }

        .progress-bar-container {
            width: 100%;
            height: 10px;
            background: var(--color-light);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            transition: width 0.5s ease;
        }

        .set-stats {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, rgba(139, 92, 246, 0.08) 100%);
            padding: 20px;
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border);
            margin-bottom: 15px;
        }

        .set-stats-title {
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 12px;
            font-size: 16px;
        }

        .set-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
        }

        .set-stat-item {
            text-align: center;
        }

        .set-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--color-primary);
        }

        .set-stat-label {
            font-size: 11px;
            color: var(--color-text-light);
            text-transform: uppercase;
            margin-top: 4px;
        }

        .reminder-section {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
            border: 1px solid var(--color-success);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
        }

        .reminder-toggle {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--color-light);
            border-radius: 13px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: 2px solid var(--color-border);
        }

        .toggle-switch.active {
            background: var(--color-success);
            border-color: var(--color-success);
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: left 0.3s ease;
        }

        .toggle-switch.active .toggle-slider {
            left: 24px;
        }

        .reminder-info {
            flex: 1;
        }

        .reminder-label {
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 4px;
        }

        .reminder-desc {
            font-size: 12px;
            color: var(--color-text-light);
        }

        .reminder-time {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
        }

        .reminder-time label {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-text);
        }

        .reminder-time input {
            padding: 8px 12px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 14px;
        }

        .reminder-time input:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .flashcard-hint {
            font-size: 12px;
            margin-top: 20px;
            opacity: 0.7;
        }

        /* ========== PROGRESS STATS ========== */
        .progress-container {
            background: var(--color-white);
            border-radius: var(--radius-lg);
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: var(--shadow-md);
        }

        .progress-header {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 25px;
        }

        .progress-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .progress-stat {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
            padding: 20px;
            border-radius: var(--radius-md);
            border-left: 4px solid var(--color-primary);
            text-align: center;
        }

        .progress-stat-label {
            font-size: 12px;
            text-transform: uppercase;
            font-weight: 600;
            color: var(--color-text-light);
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .progress-stat-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--color-primary);
        }

        .progress-bar-container {
            width: 100%;
            height: 10px;
            background: var(--color-light);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            transition: width 0.5s ease;
        }

        .set-stats {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, rgba(139, 92, 246, 0.08) 100%);
            padding: 20px;
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border);
            margin-bottom: 15px;
        }

        .set-stats-title {
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 12px;
            font-size: 16px;
        }

        .set-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
        }

        .set-stat-item {
            text-align: center;
        }

        .set-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--color-primary);
        }

        .set-stat-label {
            font-size: 11px;
            color: var(--color-text-light);
            text-transform: uppercase;
            margin-top: 4px;
        }

        .reminder-section {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
            border: 1px solid var(--color-success);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
        }

        .reminder-toggle {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--color-light);
            border-radius: 13px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: 2px solid var(--color-border);
        }

        .toggle-switch.active {
            background: var(--color-success);
            border-color: var(--color-success);
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: left 0.3s ease;
        }

        .toggle-switch.active .toggle-slider {
            left: 24px;
        }

        .reminder-info {
            flex: 1;
        }

        .reminder-label {
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 4px;
        }

        .reminder-desc {
            font-size: 12px;
            color: var(--color-text-light);
        }

        .reminder-time {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
        }

        .reminder-time label {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-text);
        }

        .reminder-time input {
            padding: 8px 12px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 14px;
        }

        .reminder-time input:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .flashcard-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .flashcard {
                padding: 40px 20px;
                min-height: 300px;
            }

            .flashcard-content {
                font-size: 24px;
            }
        }

        /* ========== QUIZ MODE ========== */
        .quiz-container {
            background: var(--color-white);
            border-radius: var(--radius-lg);
            padding: 40px;
            box-shadow: var(--shadow-lg);
            max-width: 600px;
            margin: 0 auto;
        }

        .quiz-progress-bar {
            height: 6px;
            background: var(--color-light);
            border-radius: 3px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .quiz-progress-fill {
            height: 100%;
            background: var(--color-primary);
            transition: width 0.3s ease;
        }

        .quiz-question {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 25px;
            color: var(--color-primary);
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .quiz-option {
            padding: 16px 20px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            background: var(--color-white);
            cursor: pointer;
            font-size: 16px;
            transition: var(--transition);
            text-align: left;
            position: relative;
            overflow: hidden;
        }

        .quiz-option:hover {
            border-color: var(--color-primary);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
            transform: translateX(4px);
        }

        .quiz-option.selected {
            border-color: var(--color-primary);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
        }

        .quiz-option.correct {
            border-color: var(--color-success);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
            color: var(--color-success);
            animation: pulse 0.6s var(--transition);
        }

        .quiz-option.incorrect {
            border-color: var(--color-danger);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%);
            color: var(--color-danger);
            animation: shake 0.5s var(--transition);
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        /* ========== TEST MODE ========== */
        .test-results {
            text-align: center;
            padding: 40px;
        }

        .test-score {
            font-size: 80px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            animation: scaleUpBounce 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes scaleUpBounce {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .test-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }

        .stat-box {
            background: var(--color-white);
            padding: 24px;
            border-radius: var(--radius-lg);
            border-left: 4px solid var(--color-primary);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--color-border);
            animation: fadeIn 0.6s var(--transition);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .stat-label {
            font-size: 12px;
            text-transform: uppercase;
            font-weight: 600;
            color: var(--color-text-light);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--color-primary);
        }

        /* ========== GAME MODE ========== */
        .game-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
            width: 100%;
            min-height: calc(100vh - 300px);
        }

        .game-card {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            color: var(--color-white);
            padding: 25px 15px;
            border-radius: var(--radius-lg);
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            word-break: break-word;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.2);
            line-height: 1.3;
        }

        .game-card:hover:not(.matched) {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(99, 102, 241, 0.3);
        }

        .game-card.matched {
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s 0.3s, opacity 0.3s ease;
        }

        .game-card.selected {
            background: linear-gradient(135deg, var(--color-info) 0%, #0891b2 100%);
            transform: scale(1.03);
            box-shadow: 0 8px 25px rgba(6, 182, 212, 0.4);
        }

        .game-card.correct-match {
            background: linear-gradient(135deg, var(--color-success) 0%, #059669 100%);
            animation: matchSuccess 0.4s ease;
        }

        @keyframes matchSuccess {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
                opacity: 0;
            }
        }

        .game-timer {
            font-size: 28px;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 15px;
        }

        .game-score {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-text-light);
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .game-board {
                grid-template-columns: repeat(3, 1fr);
                grid-template-rows: repeat(4, 1fr);
                gap: 10px;
            }

            .game-card {
                font-size: 14px;
                padding: 15px 10px;
            }
        }

        @media (max-width: 480px) {
            .game-board {
                grid-template-columns: repeat(2, 1fr);
                grid-template-rows: repeat(6, 1fr);
                gap: 8px;
            }

            .game-card {
                font-size: 13px;
                padding: 12px 8px;
            }
        }

        /* ========== MODAL ========== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--color-white);
            border-radius: var(--radius-lg);
            padding: 30px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--color-light);
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--color-text-light);
            transition: color 0.3s ease;
        }

        .modal-close:hover {
            color: var(--color-text);
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .nav-buttons {
                flex-direction: column;
                width: 100%;
            }

            .nav-buttons .btn {
                width: 100%;
                justify-content: center;
            }

            .hero h1 {
                font-size: 32px;
            }

            .hero p {
                font-size: 16px;
            }

            .sets-grid {
                grid-template-columns: 1fr;
            }

            .form-section {
                padding: 20px;
            }

            .quiz-container {
                padding: 20px;
            }

            .modal-content {
                max-width: 95%;
                max-height: 95vh;
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .hero h1 {
                font-size: 24px;
            }

            .study-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .flashcard {
                padding: 30px 15px;
                min-height: 250px;
            }

            .flashcard-content {
                font-size: 20px;
            }

            .game-board {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .text-center {
            text-align: center;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .btn-info {
            background-color: var(--color-info);
            color: var(--color-white);
        }

        .btn-info:hover {
            background-color: #138496;
        }

        .import-section {
            background: var(--color-light);
            padding: 20px;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
        }

        .import-section-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--color-text);
            font-size: 14px;
        }

        .separator-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .separator-btn {
            padding: 10px 15px;
            border: 2px solid var(--color-border);
            background: var(--color-white);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .separator-btn.active {
            border-color: var(--color-primary);
            background: rgba(31, 151, 198, 0.1);
            color: var(--color-primary);
        }

        .separator-btn:hover {
            border-color: var(--color-primary);
        }

        .import-textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            font-family: monospace;
            font-size: 13px;
            resize: vertical;
            min-height: 120px;
            transition: border-color 0.3s ease;
        }

        .import-textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(31, 151, 198, 0.1);
        }

        .import-preview {
            background: var(--color-white);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: 15px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .preview-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 8px;
            border-bottom: 1px solid var(--color-light);
            font-size: 12px;
        }

        .preview-row:last-child {
            border-bottom: none;
        }

        .preview-term {
            font-weight: 600;
            color: var(--color-primary);
        }

        .preview-definition {
            color: var(--color-text-light);
        }

        /* ========== WRITE MODE STYLES ========== */
        .write-answer-input {
            width: 100%;
            padding: 16px;
            font-size: 16px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            font-family: inherit;
            min-height: 60px;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .write-answer-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .answer-feedback {
            margin-top: 20px;
            padding: 20px;
            border-radius: var(--radius-md);
            border-left: 4px solid var(--color-primary);
        }

        .answer-feedback.correct {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
            border-left-color: var(--color-success);
        }

        .answer-feedback.close {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);
            border-left-color: var(--color-warning);
        }

        .answer-feedback.incorrect {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%);
            border-left-color: var(--color-danger);
        }

        .answer-label {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .answer-feedback.correct .answer-label {
            color: var(--color-success);
        }

        .answer-feedback.close .answer-label {
            color: var(--color-warning);
        }

        .answer-feedback.incorrect .answer-label {
            color: var(--color-danger);
        }

        .correct-answer {
            background: var(--color-light);
            padding: 12px;
            border-radius: var(--radius-md);
            margin-top: 12px;
            font-size: 15px;
            color: var(--color-text);
            border-left: 3px solid var(--color-success);
            padding-left: 15px;
        }

        .write-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .write-controls .btn {
            flex: 1;
            min-width: 120px;
        }

        /* ========== ASSOCIER MODE ========== */
        .associer-wrapper {
            position: relative;
            margin-top: 20px;
        }

        .associer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 25px;
            background: var(--color-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }

        .lives-container {
            display: flex;
            gap: 5px;
            font-size: 24px;
        }

        .heart {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: inline-block;
        }

        .heart.lost {
            transform: scale(0);
            opacity: 0;
        }

        .associer-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 60px;
            position: relative;
            min-height: 400px;
        }

        .associer-col {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .associer-card {
            background: var(--color-white);
            padding: 20px;
            border-radius: var(--radius-md);
            border: 2px solid var(--color-border);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-sm);
            animation: fadeInSlide 0.5s ease backwards;
            user-select: none;
            position: relative;
            z-index: 2;
        }

        @keyframes fadeInSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .associer-card:hover {
            border-color: var(--color-primary);
            transform: scale(1.02);
            box-shadow: var(--shadow-md);
        }

        .associer-card.selected {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary-active);
            transform: scale(1.05);
        }

        .associer-card.correct {
            background: var(--color-success);
            color: white;
            border-color: var(--color-success);
            opacity: 0.6;
            cursor: default;
            transform: scale(0.95);
        }

        .associer-card.wrong {
            background: var(--color-danger);
            color: white;
            border-color: var(--color-danger);
            animation: shake 0.3s ease;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-10px);
            }

            50% {
                transform: translateX(10px);
            }

            75% {
                transform: translateX(-10px);
            }
        }

        .associer-card.fade-out {
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.4s ease;
        }

        #associerLines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .svg-line {
            fill: none;
            stroke: var(--color-primary);
            stroke-width: 4;
            stroke-linecap: round;
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: drawLine 0.5s ease forwards;
            opacity: 0.5;
        }

        @keyframes drawLine {
            to {
                stroke-dashoffset: 0;
            }
        }

        /* ========== BUBBLE MODE ========== */
        .bubble-game-header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }

        .bubble-question {
            font-size: 24px;
            font-weight: 800;
            color: var(--color-primary);
            margin-bottom: 15px;
            min-height: 1.5em;
        }

        .bubble-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            font-weight: 700;
            font-size: 18px;
        }

        .bubble-stat-item {
            background: var(--color-light);
            padding: 5px 15px;
            border-radius: 20px;
        }

        .bubble-game-area {
            position: relative;
            width: 100%;
            height: 60vh;
            background: rgba(255, 255, 255, 0.5);
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            cursor: crosshair;
        }

        .bubble {
            position: absolute;
            padding: 15px 25px;
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            color: var(--color-dark);
            border: 3px solid transparent;
            transition: transform 0.2s, background-color 0.3s, border-color 0.3s;
            will-change: transform;
            z-index: 10;
        }

        .bubble:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-lg);
            z-index: 20;
        }

        .bubble.correct-anim {
            animation: bubbleBurst 0.4s ease forwards;
            pointer-events: none;
        }

        .bubble.wrong-anim {
            animation: bubbleShake 0.4s ease;
            background-color: var(--color-danger) !important;
            color: white !important;
            border-color: rgba(255, 255, 255, 0.5) !important;
        }

        @keyframes bubbleBurst {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.3);
                opacity: 0.5;
            }

            100% {
                transform: scale(0);
                opacity: 0;
            }
        }

        @keyframes bubbleShake {

            0%,
            100% {
                transform: translateX(0);
            }

            20%,
            60% {
                transform: translateX(-10px);
            }

            40%,
            80% {
                transform: translateX(10px);
            }
        }

        .difficulty-btn.active,
        .count-btn.active {
            background: var(--color-primary) !important;
            color: white !important;
            border-color: var(--color-primary-active) !important;
        }

        /* Status Badge */
        .status-badge {
            font-size: 11px;
            font-weight: 700;
            margin-left: 10px;
            padding: 4px 12px;
            border-radius: 20px;
            vertical-align: middle;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: inline-block;
            /* Reset logo styles */
            -webkit-text-fill-color: initial;
            background-clip: border-box;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.connected {
            background: var(--color-success);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status-badge.offline {
            background: var(--color-danger);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* ========== AUTH SCREEN ========== */
        .auth-screen {
            min-height: calc(100vh - 200px);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .auth-container {
            background: var(--color-white);
            border-radius: var(--radius-lg);
            padding: 40px;
            max-width: 420px;
            width: 100%;
            box-shadow: var(--shadow-lg);
            animation: fadeInUp 0.5s ease;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h2 {
            font-size: 28px;
            font-weight: 800;
            color: var(--color-primary);
            margin-bottom: 10px;
        }

        .auth-header p {
            color: var(--color-text-light);
            font-size: 14px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 25px;
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 2px solid var(--color-border);
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: var(--color-light);
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: var(--transition);
            color: var(--color-text-light);
        }

        .auth-tab.active {
            background: var(--color-primary);
            color: white;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--color-danger);
            color: var(--color-danger);
            padding: 12px;
            border-radius: var(--radius-md);
            font-size: 13px;
            text-align: center;
            display: none;
        }

        .auth-error.visible {
            display: block;
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--color-light);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: var(--transition);
        }

        .user-badge:hover {
            background: var(--color-border);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 14px;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--color-text);
        }

        /* ========== MEMBERS SCREEN ========== */
        .members-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .member-card {
            background: var(--color-white);
            border-radius: var(--radius-lg);
            padding: 25px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--color-border);
            transition: var(--transition);
        }

        .member-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .member-card.current-user {
            border-color: var(--color-primary);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
        }

        .member-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .member-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 20px;
        }

        .member-info h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--color-text);
            margin-bottom: 4px;
        }

        .member-info p {
            font-size: 12px;
            color: var(--color-text-light);
        }

        .member-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .member-stat {
            background: var(--color-light);
            padding: 12px;
            border-radius: var(--radius-md);
            text-align: center;
        }

        .member-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--color-primary);
        }

        .member-stat-label {
            font-size: 11px;
            color: var(--color-text-light);
            text-transform: uppercase;
            margin-top: 4px;
        }

        .you-badge {
            background: var(--color-primary);
            color: white;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo" onclick="app.showHome()">
                    <div class="logo-pill">
                        <span class="logo-emoji">ð</span>
                        <span class="logo-text">Quizlait</span>
                    </div>
                    <span id="firebaseStatus" class="status-badge offline">Connexion...</span>
                </div>
                <div class="nav-buttons" id="navButtons">
                    <button class="btn btn-outline btn-small" onclick="app.showHome()">Accueil</button>
                    <button class="btn btn-outline btn-small" onclick="app.showMembers()">Membres</button>
                    <button class="btn btn-primary btn-small" onclick="app.showCreateSet()">+ Nouveau Set</button>
                    <div class="user-badge" onclick="app.showUserMenu()" id="userBadge" style="display: none;">
                        <div class="user-avatar" id="userAvatar">?</div>
                        <span class="user-name" id="userName">Utilisateur</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- HOME SCREEN -->
        <div id="homeScreen" class="screen home-screen">
            <div class="hero">
                <h1>Quizlait ð</h1>
                <p>CrÃ©Ã© spÃ©cialement pour les rÃ©visions de Manon &lt;3</p>
                <div class="hero-buttons">
                    <button class="btn btn-primary" onclick="app.showCreateSet()">CrÃ©er un Set</button>
                </div>
            </div>

            <div id="progressContainer"></div>

            <div id="setsContainer"></div>
        </div>

        <!-- AUTH SCREEN -->
        <div id="authScreen" class="screen active auth-screen">
            <div class="auth-container">
                <div class="auth-header">
                    <h2>Bienvenue sur Quizlait</h2>
                    <p>Connecte-toi pour acceder a tes revisions</p>
                </div>

                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="app.switchAuthTab('login')">Connexion</button>
                    <button class="auth-tab" onclick="app.switchAuthTab('register')">Inscription</button>
                </div>

                <div id="authError" class="auth-error"></div>

                <!-- Login Form -->
                <div id="loginForm" class="auth-form">
                    <div class="form-group">
                        <label class="form-label">Adresse email</label>
                        <input type="email" id="loginEmail" class="form-input" placeholder="ton@email.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mot de passe</label>
                        <input type="password" id="loginPassword" class="form-input" placeholder="Ton mot de passe">
                    </div>
                    <button class="btn btn-primary" style="width: 100%;" onclick="app.login()">Se connecter</button>
                </div>

                <!-- Register Form -->
                <div id="registerForm" class="auth-form" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Prenom</label>
                        <input type="text" id="registerName" class="form-input" placeholder="Ton prenom">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Adresse email</label>
                        <input type="email" id="registerEmail" class="form-input" placeholder="ton@email.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mot de passe</label>
                        <input type="password" id="registerPassword" class="form-input" placeholder="Minimum 6 caracteres">
                    </div>
                    <button class="btn btn-primary" style="width: 100%;" onclick="app.register()">Creer mon compte</button>
                </div>
            </div>
        </div>

        <!-- MEMBERS SCREEN -->
        <div id="membersScreen" class="screen">
            <button class="btn btn-secondary mb-20" onclick="app.showHome()">â Retour</button>

            <div class="form-section">
                <div class="form-section-title">Membres de Quizlait</div>
                <p style="color: var(--color-text-light); margin-bottom: 20px;">
                    Tous les membres partagent les memes questions/reponses. Chacun a ses propres statistiques.
                </p>
                <div id="membersContainer" class="members-grid"></div>
            </div>
        </div>

        <!-- CREATE/EDIT SET SCREEN -->
        <div id="createSetScreen" class="screen">
            <button class="btn btn-secondary mb-20" onclick="app.showHome()">â Retour</button>

            <div class="form-section">
                <div class="form-section-title">Informations du Set</div>

                <div class="form-group">
                    <label class="form-label">Titre du Set</label>
                    <input type="text" id="setTitle" class="form-input" placeholder="Ex: Vocabulaire anglais">
                </div>

                <div class="form-group">
                    <label class="form-label">Description (optionnel)</label>
                    <textarea id="setDescription" class="form-input"
                        placeholder="DÃ©cris ce que contient ce set..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <div class="form-section-title">Ajouter des Cartes</div>

                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-primary add-card-btn" onclick="app.addFlashcardInput()">+ Ajouter une
                        Carte</button>
                    <button class="btn btn-info" onclick="app.showImportModal()"
                        style="background-color: var(--color-info);">ð Importer depuis Texte</button>
                </div>

                <div id="flashcardsContainer"></div>
            </div>

            <div class="form-section">
                <button class="btn btn-success" style="width: 100%; margin-bottom: 10px;" onclick="app.saveSet()">ð¾
                    Sauvegarder le Set</button>
                <button class="btn btn-secondary" style="width: 100%;" onclick="app.showHome()">Annuler</button>
            </div>
        </div>

        <!-- IMPORT MODAL -->
        <div id="importModal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <div class="modal-title">ð Importer des Cartes</div>
                    <button class="modal-close" onclick="app.closeImportModal()">Ã</button>
                </div>

                <div class="import-section">
                    <div class="import-section-title">Choisis un sÃ©parateur de colonne</div>
                    <div class="separator-selector">
                        <button class="separator-btn active" onclick="app.setSeparator('\t', this)">Tab â</button>
                        <button class="separator-btn" onclick="app.setSeparator(';', this)">Point-virgule;</button>
                        <button class="separator-btn" onclick="app.setSeparator(',', this)">Virgule,</button>
                        <button class="separator-btn" onclick="app.setSeparator('|', this)">Pipe |</button>
                        <button class="separator-btn" onclick="app.setSeparator('-', this)">Tiret -</button>
                    </div>
                </div>

                <div class="import-section">
                    <div class="import-section-title">Colle ton texte ici (une paire par ligne)</div>
                    <textarea id="importTextarea" class="import-textarea"
                        placeholder="Terme&#9;DÃ©finition&#10;Exemple&#9;Une dÃ©monstration&#10;..."
                        oninput="app.updateImportPreview()"></textarea>
                </div>

                <div class="import-section">
                    <div class="import-section-title">AperÃ§u des cartes</div>
                    <div id="importPreview" class="import-preview"></div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-success" style="flex: 1;" onclick="app.importCards()">â Importer</button>
                    <button class="btn btn-secondary" style="flex: 1;" onclick="app.closeImportModal()">Annuler</button>
                </div>
            </div>
        </div>

        <!-- STUDY SCREEN -->
        <div id="studyScreen" class="screen">
            <button class="btn btn-secondary mb-20" onclick="app.showHome()">â Retour</button>

            <div class="study-header">
                <div>
                    <div class="study-title" id="studySetTitle"></div>
                    <div class="study-progress" id="studyProgress"></div>
                </div>
                <button class="btn btn-outline" onclick="app.showHome()">Quitter</button>
            </div>

            <div class="study-mode-selector">
                <button class="mode-btn active" onclick="app.switchMode('cards')">ð Cartes</button>
                <button class="mode-btn" onclick="app.switchMode('learn')">ð Apprendre</button>
                <button class="mode-btn" onclick="app.switchMode('write')">âï¸ RÃ©ponse Libre</button>
                <button class="mode-btn" onclick="app.switchMode('test')">ð Test</button>
                <button class="mode-btn" onclick="app.switchMode('game')">ð® Match (Vitesse)</button>
                <button class="mode-btn" onclick="app.switchMode('associer')">ð Associer (PrÃ©cision)</button>
                <button class="mode-btn" onclick="app.switchMode('bulles')">ð«§ Bulles (Fun)</button>
                <button class="mode-btn" onclick="app.switchMode('mistakes')">ð Mes Erreurs</button>
                <button class="mode-btn" id="incorrectBtn" onclick="app.switchMode('incorrect')"
                    style="display: none; background-color: rgba(220, 53, 69, 0.2); color: var(--color-danger); border-color: var(--color-danger);">â
                    Session Erreurs</button>
            </div>

            <!-- CARDS MODE -->
            <div id="cardsMode" class="study-content">
                <div class="flashcard-container">
                    <div class="flashcard" id="mainFlashcard" onclick="app.toggleFlashcard()">
                        <div class="flashcard-label" id="flashcardLabel">TERME</div>
                        <div class="flashcard-content" id="flashcardContent">Clique pour afficher</div>
                        <div class="flashcard-hint">Clique pour retourner la carte</div>
                    </div>
                </div>

                <div class="flashcard-controls">
                    <button class="btn btn-secondary" onclick="app.previousCard()">â PrÃ©cÃ©dent</button>
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                        <span style="padding: 10px; font-weight: 600;" id="cardCounter">1/1</span>
                        <button id="wrongBtn" class="btn btn-danger btn-small" onclick="app.markAsError()"
                            style="display: none; width: 100%;">Je me suis trompÃ©</button>
                    </div>
                    <button class="btn btn-secondary" onclick="app.nextCard()">Suivant â</button>
                </div>

            </div>

            <!-- LEARN MODE -->
            <div id="learnMode" class="study-content" style="display: none;">
                <div class="quiz-container" id="learnContainer"></div>
            </div>

            <!-- TEST MODE -->
            <div id="testMode" class="study-content" style="display: none;">
                <div class="quiz-container" id="testContainer"></div>
            </div>

            <!-- GAME MODE -->
            <div id="gameMode" class="study-content" style="display: none;">
                <div style="text-align: center;">
                    <div
                        style="display: flex; justify-content: center; align-items: center; gap: 30px; margin-bottom: 20px; flex-wrap: wrap;">
                        <div class="game-timer" id="gameTimer" style="margin: 0;">PrÃªt?</div>
                        <div class="game-score" id="gameScore" style="margin: 0;">Matchs trouvÃ©s: 0/6</div>
                    </div>
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-primary" id="startGameBtn" onclick="app.startGame()"
                            style="font-size: 18px; padding: 15px 40px;">ð® Commencer le Match</button>
                        <button class="btn btn-danger" id="quitGameBtn" onclick="app.quitGame()"
                            style="font-size: 16px; padding: 12px 25px; display: none;">â Quitter le match</button>
                    </div>
                    <div id="gameBoard" class="game-board" style="display: none;"></div>
                </div>
            </div>

            <!-- WRITE MODE -->
            <div id="writeMode" class="study-content" style="display: none;">
                <div class="quiz-container" id="writeContainer"></div>
            </div>

            <!-- INCORRECT MODE -->
            <div id="incorrectMode" class="study-content" style="display: none;">
                <div id="incorrectContainer"></div>
            </div>

            <!-- MISTAKES MODE -->
            <div id="mistakesMode" class="study-content" style="display: none;">
                <div class="quiz-container" id="mistakesContainer"></div>
            </div>

            <!-- ========== MODE ASSOCIER ========== -->
            <div id="associerMode" class="study-content" style="display: none;">
                <div class="associer-header">
                    <div id="associerProgress" style="font-weight: 600; color: var(--color-primary);">Paires: 0/0</div>
                    <div class="lives-container" id="livesContainer">
                        <span class="heart" data-idx="0">â¤ï¸</span>
                        <span class="heart" data-idx="1">â¤ï¸</span>
                        <span class="heart" data-idx="2">â¤ï¸</span>
                        <span class="heart" data-idx="3">â¤ï¸</span>
                        <span class="heart" data-idx="4">â¤ï¸</span>
                    </div>
                </div>

                <div class="associer-wrapper">
                    <svg id="associerLines"></svg>
                    <div class="associer-grid">
                        <div class="associer-col" id="associerLeftCol">
                            <!-- Termes -->
                        </div>
                        <div class="associer-col" id="associerRightCol">
                            <!-- DÃ©finitions -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== BUBBLE MODE ========== -->
            <div id="bubbleMode" class="study-content" style="display: none;">
                <div class="bubble-game-header">
                    <div id="bubbleQuestion" class="bubble-question">Question ?</div>
                    <div class="bubble-stats">
                        <div class="bubble-stat-item">â <span id="bubbleScore">0</span></div>
                        <div class="bubble-stat-item">â <span id="bubbleErrors">0</span></div>
                        <div class="bubble-stat-item">â±ï¸ <span id="bubbleChrono">00:00</span></div>
                    </div>
                </div>
                <div id="bubbleGameArea" class="bubble-game-area">
                    <!-- Les bulles seront gÃ©nÃ©rÃ©es ici -->
                </div>
                <div class="bubble-controls" style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-secondary" onclick="app.showHome()">Quitter</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CARD LIMIT SELECTOR MODAL -->
    <div id="cardLimitModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <div class="modal-title">ð SÃ©lectionner les cartes</div>
                <button class="modal-close" onclick="app.closeCardLimitModal()">Ã</button>
            </div>

            <div style="padding: 20px; text-align: center;">
                <p style="margin-bottom: 20px; color: var(--color-text-light);">Combien de cartes veux-tu rÃ©viser?</p>

                <div style="margin-bottom: 20px;">
                    <input type="number" id="cardLimitInput" class="form-input" placeholder="Nombre de cartes" min="1"
                        style="text-align: center; font-size: 18px;">
                </div>

                <p style="color: var(--color-text-light); font-size: 12px; margin-bottom: 20px;">
                    Total disponible: <strong id="totalCardsCount">0</strong> cartes
                </p>

                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-outline" style="flex: 1;" onclick="app.startModeWithAllCards()">Toutes les
                        cartes</button>
                    <button class="btn btn-primary" style="flex: 1;"
                        onclick="app.startModeWithLimit()">PersonnalisÃ©</button>
                </div>
            </div>
        </div>
    </div>

    <!-- DIFFICULTÃ BULLER MODAL -->
    <div id="bubbleDifficultyModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <div class="modal-title">ð«§ Configuration Mode Bulles</div>
                <button class="modal-close" onclick="app.closeBubbleDifficultyModal()">Ã</button>
            </div>

            <div style="padding: 20px;">
                <p style="margin-bottom: 20px; text-align: center; color: var(--color-text-light);">PrÃ©parez-vous Ã 
                    Ã©clater des bulles !</p>

                <div class="form-group">
                    <label class="form-label">ð¥ DifficultÃ© (Vitesse)</label>
                    <div class="difficulty-options" style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="btn btn-outline difficulty-btn active"
                            style="flex: 1; border-color: var(--color-success); color: var(--color-success);"
                            onclick="app.setBubbleDifficulty(1, this)">Lent</button>
                        <button class="btn btn-outline difficulty-btn"
                            style="flex: 1; border-color: var(--color-warning); color: var(--color-warning);"
                            onclick="app.setBubbleDifficulty(2, this)">Moyen</button>
                        <button class="btn btn-outline difficulty-btn"
                            style="flex: 1; border-color: var(--color-danger); color: var(--color-danger);"
                            onclick="app.setBubbleDifficulty(3, this)">Rapide</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">ð Nombre de bulles</label>
                    <div class="bubble-count-options" style="display: flex; gap: 10px;">
                        <button class="btn btn-outline count-btn" style="flex: 1;"
                            onclick="app.setBubbleCount(3, this)">3</button>
                        <button class="btn btn-outline count-btn" style="flex: 1;"
                            onclick="app.setBubbleCount(6, this)">6</button>
                        <button class="btn btn-outline count-btn active" style="flex: 1;"
                            onclick="app.setBubbleCount(10, this)">10</button>
                    </div>
                </div>

                <button class="btn btn-primary" style="width: 100%; margin-top: 30px; font-size: 18px; padding: 15px;"
                    onclick="app.startBubbleGame()">
                    ð® Lancer la partie
                </button>
            </div>
        </div>
    </div>

    <!-- DIFFICULTÃ ASSOCIER MODAL -->
    <div id="associerDifficultyModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <div class="modal-title">âï¸ Choisir la difficultÃ©</div>
                <button class="modal-close" onclick="app.closeAssocierDifficultyModal()">Ã</button>
            </div>

            <div style="padding: 20px; text-align: center;">
                <p style="margin-bottom: 25px; color: var(--color-text-light);">Combien de vies veux-tu pour cette
                    session ?</p>

                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="btn btn-outline"
                        style="width: 100%; border-color: var(--color-success); color: var(--color-success);"
                        onclick="app.selectAssocierDifficulty(5)">
                        ð¢ Facile (5 cÅurs)
                    </button>
                    <button class="btn btn-outline"
                        style="width: 100%; border-color: var(--color-warning); color: var(--color-warning);"
                        onclick="app.selectAssocierDifficulty(3)">
                        ð¡ IntermÃ©diaire (3 cÅurs)
                    </button>
                    <button class="btn btn-outline"
                        style="width: 100%; border-color: var(--color-danger); color: var(--color-danger);"
                        onclick="app.selectAssocierDifficulty(1)">
                        ð Hardcore (1 cÅur)
                    </button>

                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--color-border);">
                        <p style="font-size: 13px; font-weight: 600; margin-bottom: 10px;">âï¸ Mode PersonnalisÃ©</p>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="associerCustomLives" class="form-input"
                                placeholder="Nombre de vies" min="1" max="20"
                                style="text-align: center; font-size: 16px; flex: 1;">
                            <button class="btn btn-primary" style="padding: 0 15px;"
                                onclick="app.selectAssocierCustomDifficulty()">Valider</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== PHYSIQUE DES BULLES ==========
        class BubblePhysics {
            constructor(container, options, correctDef, onResult, difficulty) {
                this.container = container;
                this.options = options;
                this.correctDef = correctDef;
                this.onResult = onResult;
                this.difficulty = difficulty;
                this.bubbles = [];
                this.running = false;
                this.lastTime = 0;

                // Vitesse selon difficultÃ©
                this.baseSpeed = difficulty === 1 ? 1 : difficulty === 2 ? 2.5 : 4.5;
            }

            start() {
                const rect = this.container.getBoundingClientRect();
                this.bubbles = this.options.map(text => {
                    const el = document.createElement('div');
                    el.className = 'bubble';
                    el.textContent = text;
                    this.container.appendChild(el);

                    const bRect = el.getBoundingClientRect();
                    const x = Math.random() * (rect.width - bRect.width);
                    const y = Math.random() * (rect.height - bRect.height);
                    const angle = Math.random() * Math.PI * 2;

                    // Couleur alÃ©atoire attrayante
                    const hue = Math.floor(Math.random() * 360);
                    el.style.backgroundColor = `hsla(${hue}, 70%, 95%, 1)`;
                    el.style.borderColor = `hsla(${hue}, 70%, 80%, 1)`;
                    el.style.color = `hsla(${hue}, 70%, 30%, 1)`;

                    const b = {
                        el,
                        text,
                        x, y,
                        vx: Math.cos(angle) * this.baseSpeed,
                        vy: Math.sin(angle) * this.baseSpeed,
                        w: bRect.width,
                        h: bRect.height
                    };

                    el.onclick = () => this.handleClick(b);
                    return b;
                });

                this.running = true;
                requestAnimationFrame((t) => this.loop(t));
            }

            stop() {
                this.running = false;
            }

            handleClick(b) {
                if (b.text === this.correctDef) {
                    b.el.classList.add('correct-anim');
                    setTimeout(() => this.onResult(true, b.el), 400);
                } else {
                    b.el.classList.add('wrong-anim');
                    this.onResult(false, b.el);
                    setTimeout(() => b.el.classList.remove('wrong-anim'), 400);
                }
            }

            loop(time) {
                if (!this.running) return;

                const delta = time - this.lastTime;
                this.lastTime = time;

                const rect = this.container.getBoundingClientRect();

                this.bubbles.forEach(b => {
                    b.x += b.vx;
                    b.y += b.vy;

                    // Rebondissements bords
                    if (b.x <= 0) { b.x = 0; b.vx *= -1; }
                    if (b.x + b.w >= rect.width) { b.x = rect.width - b.w; b.vx *= -1; }
                    if (b.y <= 0) { b.y = 0; b.vy *= -1; }
                    if (b.y + b.h >= rect.height) { b.y = rect.height - b.h; b.vy *= -1; }

                    b.el.style.transform = `translate3d(${b.x}px, ${b.y}px, 0)`;
                });

                requestAnimationFrame((t) => this.loop(t));
            }
        }

        const app = {
            // Auth
            currentUser: null,
            users: {},
            auth: null,

            sets: [],
            currentSetId: null,
            currentSet: null,
            currentCardIndex: 0,
            currentMode: 'cards',
            isFlipped: false,
            learnedCards: {},
            testAnswers: {},
            incorrectCards: [],
            incorrectCardIndex: 0,
            incorrectFlipped: false,
            mistakesCardIndex: 0,
            mistakesFlipped: false,
            gameMatched: [],
            gameSelected: [],
            gameScore: 0,
            gameActive: false,
            currentGameCards: [],
            gameTimerInterval: null,
            importSeparator: '\t',
            importedCards: [],
            mistakeCards: [],
            cardsToStudy: [],
            cardLimitForMode: null,
            stats: {
                totalSessions: 0,
                totalQuestionsAnswered: 0,
                totalCorrectAnswers: 0,
                sets: {} // { setId: { sessions, questionsAnswered, correctAnswers, lastStudied } }
            },
            reminderEnabled: false,
            reminderTimes: ['09:00'],
            reminderCheckInterval: null,

            // Associer Mode specific
            associerLives: 5,
            associerMatched: 0,
            associerTotalPairs: 0,
            associerPairesPerManche: 5,
            associerCurrentPaires: [],
            associerSelectedTerm: null,
            associerSelectedDef: null,
            associerErrors: 0,
            associerSuccesses: 0,
            cardsLeftToAssocier: [],
            associerPool: [],
            associerMatchedInManche: 0,

            // Bubble Mode specific
            bubbleDifficulty: 1,
            bubbleCount: 10,
            bubbleScore: 0,
            bubbleErrors: 0,
            bubbleGame: null,
            bubbleCards: [],
            bubbleCorrectCard: null,
            bubbleStartTime: null,
            bubbleTimerInterval: null,


            init() {
                this.initFirebase();
            },

            initFirebase() {
                const firebaseConfig = {
                    apiKey: "AIzaSyD6OhvGyXPSUp6wNFeaZxvvck6d2ELkAa0",
                    authDomain: "quizlait.firebaseapp.com",
                    databaseURL: "https://quizlait-default-rtdb.europe-west1.firebasedatabase.app",
                    projectId: "quizlait",
                    storageBucket: "quizlait.firebasestorage.app",
                    messagingSenderId: "139659114587",
                    appId: "1:139659114587:web:ef29c7f4a88a17c650e77e",
                    measurementId: "G-FPWBT5XBGR"
                };

                firebase.initializeApp(firebaseConfig);
                this.db = firebase.database();
                this.auth = firebase.auth();
                this.analytics = firebase.analytics();

                const statusEl = document.getElementById('firebaseStatus');

                this.db.ref('.info/connected').on('value', (snapshot) => {
                    if (snapshot.val() === true) {
                        statusEl.textContent = 'â Connecte';
                        statusEl.classList.remove('offline');
                        statusEl.classList.add('connected');
                    } else {
                        statusEl.textContent = 'â Hors ligne';
                        statusEl.classList.remove('connected');
                        statusEl.classList.add('offline');
                    }
                });

                // Listen for auth state changes
                this.auth.onAuthStateChanged((user) => {
                    if (user) {
                        this.currentUser = user;
                        this.onUserLoggedIn(user);
                    } else {
                        this.currentUser = null;
                        this.showAuthScreen();
                    }
                });
            },

            onUserLoggedIn(user) {
                // Update UI with user info
                document.getElementById('userBadge').style.display = 'flex';
                document.getElementById('userAvatar').textContent = (user.displayName || user.email)[0].toUpperCase();
                document.getElementById('userName').textContent = user.displayName || user.email.split('@')[0];

                // Listen for data changes
                this.db.ref('/').on('value', (snapshot) => {
                    const data = snapshot.val() || {};
                    this.sets = data.sets || [];
                    this.mistakeCards = data.mistakeCards || [];
                    this.users = data.users || {};

                    // Get current user's stats
                    const userStats = this.users[user.uid]?.stats;
                    if (userStats) {
                        this.stats = userStats;
                    } else {
                        this.stats = {
                            totalSessions: 0,
                            totalQuestionsAnswered: 0,
                            totalCorrectAnswers: 0,
                            sets: {}
                        };
                    }

                    if (data.reminder) {
                        this.reminderEnabled = data.reminder.enabled;
                        this.reminderTimes = data.reminder.times || ['09:00'];
                    }

                    this.renderHome();
                    if (this.currentSetId) {
                        this.currentSet = this.sets.find(s => s.id === this.currentSetId);
                    }
                });

                this.initializeReminder();
                this.switchScreen('homeScreen');
                this.renderHome();
            },

            // ========== AUTH METHODS ==========
            showAuthScreen() {
                document.getElementById('userBadge').style.display = 'none';
                this.switchScreen('authScreen');
            },

            switchAuthTab(tab) {
                const loginForm = document.getElementById('loginForm');
                const registerForm = document.getElementById('registerForm');
                const tabs = document.querySelectorAll('.auth-tab');

                tabs.forEach(t => t.classList.remove('active'));

                if (tab === 'login') {
                    loginForm.style.display = 'flex';
                    registerForm.style.display = 'none';
                    tabs[0].classList.add('active');
                } else {
                    loginForm.style.display = 'none';
                    registerForm.style.display = 'flex';
                    tabs[1].classList.add('active');
                }

                this.hideAuthError();
            },

            showAuthError(message) {
                const errorEl = document.getElementById('authError');
                errorEl.textContent = message;
                errorEl.classList.add('visible');
            },

            hideAuthError() {
                document.getElementById('authError').classList.remove('visible');
            },

            async login() {
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;

                if (!email || !password) {
                    this.showAuthError('Veuillez remplir tous les champs');
                    return;
                }

                try {
                    await this.auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    let message = 'Erreur de connexion';
                    if (error.code === 'auth/user-not-found') {
                        message = 'Aucun compte avec cet email';
                    } else if (error.code === 'auth/wrong-password') {
                        message = 'Mot de passe incorrect';
                    } else if (error.code === 'auth/invalid-email') {
                        message = 'Email invalide';
                    }
                    this.showAuthError(message);
                }
            },

            async register() {
                const name = document.getElementById('registerName').value.trim();
                const email = document.getElementById('registerEmail').value.trim();
                const password = document.getElementById('registerPassword').value;

                if (!name || !email || !password) {
                    this.showAuthError('Veuillez remplir tous les champs');
                    return;
                }

                if (password.length < 6) {
                    this.showAuthError('Le mot de passe doit contenir au moins 6 caracteres');
                    return;
                }

                try {
                    const result = await this.auth.createUserWithEmailAndPassword(email, password);
                    await result.user.updateProfile({ displayName: name });

                    // Save user to database
                    await this.db.ref(`users/${result.user.uid}`).set({
                        email: email,
                        displayName: name,
                        createdAt: new Date().toISOString(),
                        stats: {
                            totalSessions: 0,
                            totalQuestionsAnswered: 0,
                            totalCorrectAnswers: 0,
                            sets: {}
                        }
                    });
                } catch (error) {
                    let message = 'Erreur lors de la creation du compte';
                    if (error.code === 'auth/email-already-in-use') {
                        message = 'Cet email est deja utilise';
                    } else if (error.code === 'auth/invalid-email') {
                        message = 'Email invalide';
                    } else if (error.code === 'auth/weak-password') {
                        message = 'Mot de passe trop faible';
                    }
                    this.showAuthError(message);
                }
            },

            async logout() {
                try {
                    await this.auth.signOut();
                } catch (error) {
                    console.error('Erreur deconnexion:', error);
                }
            },

            showUserMenu() {
                if (confirm('Voulez-vous vous deconnecter?')) {
                    this.logout();
                }
            },

            // ========== MEMBERS ==========
            showMembers() {
                this.switchScreen('membersScreen');
                this.renderMembers();
            },

            renderMembers() {
                const container = document.getElementById('membersContainer');
                const usersArray = Object.entries(this.users).map(([uid, data]) => ({
                    uid,
                    ...data
                }));

                if (usersArray.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--color-text-light);">Aucun membre pour le moment</p>';
                    return;
                }

                container.innerHTML = usersArray.map(user => {
                    const isCurrentUser = this.currentUser && user.uid === this.currentUser.uid;
                    const stats = user.stats || { totalSessions: 0, totalQuestionsAnswered: 0, totalCorrectAnswers: 0 };
                    const successRate = stats.totalQuestionsAnswered > 0
                        ? Math.round((stats.totalCorrectAnswers / stats.totalQuestionsAnswered) * 100)
                        : 0;
                    const createdDate = user.createdAt
                        ? new Date(user.createdAt).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' })
                        : 'Date inconnue';

                    return `
                        <div class="member-card ${isCurrentUser ? 'current-user' : ''}">
                            <div class="member-header">
                                <div class="member-avatar">${(user.displayName || user.email)[0].toUpperCase()}</div>
                                <div class="member-info">
                                    <h3>${this.escapeHtml(user.displayName || user.email.split('@')[0])}${isCurrentUser ? '<span class="you-badge">Toi</span>' : ''}</h3>
                                    <p>Membre depuis ${createdDate}</p>
                                </div>
                            </div>
                            <div class="member-stats">
                                <div class="member-stat">
                                    <div class="member-stat-value">${stats.totalSessions}</div>
                                    <div class="member-stat-label">Sessions</div>
                                </div>
                                <div class="member-stat">
                                    <div class="member-stat-value">${stats.totalQuestionsAnswered}</div>
                                    <div class="member-stat-label">Questions</div>
                                </div>
                                <div class="member-stat">
                                    <div class="member-stat-value">${stats.totalCorrectAnswers}</div>
                                    <div class="member-stat-label">Correctes</div>
                                </div>
                                <div class="member-stat">
                                    <div class="member-stat-value" style="color: ${successRate >= 70 ? 'var(--color-success)' : successRate >= 50 ? 'var(--color-warning)' : 'var(--color-danger)'};">${successRate}%</div>
                                    <div class="member-stat-label">Reussite</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            // ========== STORAGE ==========
            loadFromStorage() {
                // Now using Firebase listener in initFirebase
            },

            normalizeString(str) {
                return str.toLowerCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .trim();
            },

            checkAnswerSimilarity(userAnswer, correctAnswer) {
                const normalized1 = this.normalizeString(userAnswer);
                const normalized2 = this.normalizeString(correctAnswer);

                if (normalized1 === normalized2) {
                    return 'correct';
                }

                const similarity = this.calculateSimilarity(normalized1, normalized2);
                if (similarity > 0.7) {
                    return 'close';
                }

                return 'incorrect';
            },

            calculateSimilarity(str1, str2) {
                const longer = str1.length > str2.length ? str1 : str2;
                const shorter = str1.length > str2.length ? str2 : str1;

                if (longer.length === 0) return 1.0;

                const editDistance = this.levenshteinDistance(longer, shorter);
                return (longer.length - editDistance) / longer.length;
            },

            levenshteinDistance(s1, s2) {
                const costs = [];
                for (let k = 0; k <= s1.length; k++) costs[k] = k;
                for (let k = 0; k <= s2.length; k++) costs[0] = k;

                for (let i = 1; i <= s1.length; i++) {
                    for (let j = 1; j <= s2.length; j++) {
                        if (s1[i - 1] === s2[j - 1]) {
                            costs[j] = costs[j - 1];
                        } else {
                            costs[j] = Math.min(costs[j - 1], costs[j], costs[j - 1]) + 1;
                        }
                    }
                }
                return costs[s2.length];
            },

            saveToStorage() {
                // Save shared data (sets, mistakeCards, reminder)
                const sharedData = {
                    sets: this.sets,
                    mistakeCards: this.mistakeCards,
                    reminder: {
                        enabled: this.reminderEnabled,
                        times: this.reminderTimes
                    }
                };

                // Update shared data
                this.db.ref('/sets').set(this.sets);
                this.db.ref('/mistakeCards').set(this.mistakeCards);
                this.db.ref('/reminder').set({
                    enabled: this.reminderEnabled,
                    times: this.reminderTimes
                });

                // Save user-specific stats
                if (this.currentUser) {
                    this.db.ref(`users/${this.currentUser.uid}/stats`).set(this.stats);
                }
            },

            // ========== REMINDER SYSTEM ==========
            initializeReminder() {
                if (this.reminderCheckInterval) {
                    clearInterval(this.reminderCheckInterval);
                }

                if (!this.reminderEnabled) return;

                this.reminderCheckInterval = setInterval(() => {
                    this.checkAndTriggerReminder();
                }, 60000); // Check every minute

                // Also check immediately
                this.checkAndTriggerReminder();
            },

            checkAndTriggerReminder() {
                if (!this.reminderEnabled || this.sets.length === 0 || this.reminderTimes.length === 0) return;

                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                const todayDate = now.toDateString();

                // RÃ©cupÃ©rer les rappels dÃ©jÃ  dÃ©clenchÃ©s aujourd'hui (on peut garder localStorage pour Ã§a car c'est spÃ©cifique au navigateur/appareil)
                const triggeredToday = JSON.parse(localStorage.getItem('quizletTriggeredReminders') || '{}');

                // Nettoyer si c'est un nouveau jour
                if (triggeredToday.date !== todayDate) {
                    triggeredToday.date = todayDate;
                    triggeredToday.times = [];
                }

                // VÃ©rifier chaque heure de rappel
                for (const time of this.reminderTimes) {
                    const [reminderHour, reminderMinute] = time.split(':').map(Number);

                    // Si l'heure correspond et n'a pas encore Ã©tÃ© dÃ©clenchÃ©e aujourd'hui
                    if (currentHour === reminderHour && currentMinute === reminderMinute && !triggeredToday.times.includes(time)) {
                        this.triggerReminder();
                        triggeredToday.times.push(time);
                        localStorage.setItem('quizletTriggeredReminders', JSON.stringify(triggeredToday));
                        break; // Un seul rappel Ã  la fois
                    }
                }
            },

            triggerReminder() {
                const allCards = [];
                this.sets.forEach(set => {
                    set.cards.forEach(card => {
                        allCards.push({ ...card, setId: set.id, setTitle: set.title });
                    });
                });

                const cardsToReview = [];
                const shuffled = [...allCards].sort(() => Math.random() - 0.5);
                for (let i = 0; i < Math.min(15, shuffled.length); i++) {
                    cardsToReview.push(shuffled[i]);
                }

                // Request notification permission
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('ð Quizlait - Temps de RÃ©viser!', {
                        body: `Vous avez ${cardsToReview.length} cartes Ã  rÃ©viser aujourd'hui!`,
                        icon: 'ð'
                    });
                } else if ('Notification' in window && Notification.permission !== 'denied') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            new Notification('ð Quizlait - Temps de RÃ©viser!', {
                                body: `Vous avez ${cardsToReview.length} cartes Ã  rÃ©viser aujourd'hui!`,
                                icon: 'ð'
                            });
                        }
                    });
                }

                // Also show in-app notification
                this.showInAppReminder(cardsToReview);
            },

            showInAppReminder(cardsToReview) {
                const reminder = document.createElement('div');
                reminder.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, var(--color-success) 0%, #059669 100%);
                    color: white;
                    padding: 20px;
                    border-radius: 12px;
                    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
                    z-index: 10000;
                    max-width: 350px;
                    animation: slideInRight 0.3s ease;
                `;
                reminder.innerHTML = `
                    <div style="font-weight: 700; margin-bottom: 10px; font-size: 16px;">ð Rappel de RÃ©vision</div>
                    <div style="font-size: 14px; margin-bottom: 15px;">Vous avez ${cardsToReview.length} cartes alÃ©atoires Ã  rÃ©viser aujourd'hui!</div>
                    <button class="btn btn-success" style="width: 100%; background: white; color: var(--color-success); border: none; cursor: pointer;" onclick="app.startDailyReview(); this.parentElement.remove();">Commencer</button>
                `;
                document.body.appendChild(reminder);

                setTimeout(() => {
                    if (reminder.parentElement) reminder.remove();
                }, 10000);
            },

            startDailyReview() {
                const allCards = [];
                this.sets.forEach(set => {
                    set.cards.forEach(card => {
                        allCards.push({ ...card, setId: set.id, setTitle: set.title });
                    });
                });

                const cardsToReview = [];
                const shuffled = [...allCards].sort(() => Math.random() - 0.5);
                for (let i = 0; i < Math.min(15, shuffled.length); i++) {
                    cardsToReview.push(shuffled[i]);
                }

                this.currentMode = 'test';
                this.cardsToStudy = cardsToReview;
                this.currentCardIndex = 0;
                this.testAnswers = {};
                this.incorrectCards = [];

                this.switchScreen('studyScreen');
                this.updateStudyHeader();
                this.renderTestMode();
            },

            toggleReminder() {
                this.reminderEnabled = !this.reminderEnabled;
                this.saveToStorage();
                this.initializeReminder();
                this.renderHome(); // Re-render pour mettre Ã  jour l'affichage
            },

            addReminder() {
                const newTime = document.getElementById('newReminderTime').value;
                if (!newTime) {
                    alert('SÃ©lectionne une heure pour le rappel');
                    return;
                }

                if (this.reminderTimes.includes(newTime)) {
                    alert('Ce rappel existe dÃ©jÃ !');
                    return;
                }

                if (this.reminderTimes.length >= 5) {
                    alert('Maximum 5 rappels autorisÃ©s');
                    return;
                }

                this.reminderTimes.push(newTime);
                this.reminderTimes.sort(); // Trier par ordre chronologique
                this.saveToStorage();
                this.initializeReminder();
                this.renderHome();
            },

            removeReminder(time) {
                this.reminderTimes = this.reminderTimes.filter(t => t !== time);
                if (this.reminderTimes.length === 0) {
                    this.reminderTimes = ['09:00']; // Garder au moins un rappel par dÃ©faut
                }
                this.saveToStorage();
                this.initializeReminder();
                this.renderHome();
            },

            updateReminderTime(index, newTime) {
                if (this.reminderTimes.includes(newTime) && this.reminderTimes[index] !== newTime) {
                    alert('Ce rappel existe dÃ©jÃ !');
                    return;
                }
                this.reminderTimes[index] = newTime;
                this.reminderTimes.sort();
                this.saveToStorage();
                this.initializeReminder();
            },

            // ========== SCREEN NAVIGATION ==========
            showHome() {
                // ArrÃªter tout jeu en cours
                this.stopGame();
                this.switchScreen('homeScreen');
                this.renderHome();
            },

            showCreateSet() {
                this.currentSetId = null;
                this.currentCardIndex = 0;
                this.resetCreateForm();
                this.switchScreen('createSetScreen');
            },

            showStudyScreen(setId) {
                this.currentSetId = setId;
                this.currentSet = this.sets.find(s => s.id === setId);
                this.currentCardIndex = 0;
                this.currentMode = 'cards';
                this.isFlipped = false;
                this.learnedCards = {};
                this.testAnswers = {};
                this.writeAnswers = {};
                this.gameMatches = [];
                this.gameSelected = [];
                this.gameScore = 0;
                this.cardsToStudy = [...this.currentSet.cards].sort(() => Math.random() - 0.5);

                this.switchScreen('studyScreen');
                this.updateStudyHeader();
                this.renderCardsMode();
            },

            switchScreen(screenId) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(screenId).classList.add('active');
            },

            // ========== HOME SCREEN ==========
            renderHome() {
                const container = document.getElementById('setsContainer');
                const progressContainer = document.getElementById('progressContainer');

                // Render overall progress
                this.renderOverallProgress(progressContainer);

                if (this.sets.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ð</div>
                            <p>Aucun set crÃ©Ã© pour le moment</p>
                            <button class="btn btn-primary" onclick="app.showCreateSet()">CrÃ©er ton premier Set</button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div class="sets-grid">
                        ${this.sets.map(set => `
                            <div class="set-card">
                                <div class="set-card-title">${this.escapeHtml(set.title)}</div>
                                <div class="set-card-count">${set.cards.length} carte${set.cards.length > 1 ? 's' : ''}</div>
                                <div class="set-card-actions">
                                    <button class="btn btn-primary" onclick="app.showStudyScreen(${set.id})">RÃ©viser</button>
                                    <button class="btn btn-secondary btn-small" onclick="app.editSet(${set.id})">âï¸</button>
                                    <button class="btn btn-danger btn-small" onclick="app.deleteSet(${set.id})">ðï¸</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            renderOverallProgress(container) {
                const totalSets = this.sets.length;
                const totalCards = this.sets.reduce((sum, set) => sum + set.cards.length, 0);
                const globalStats = this.getGlobalStats();
                const totalMistakes = this.mistakeCards.length;

                const progressHtml = `
                    <div class="progress-container">
                        <div class="progress-header">ð Statistiques Globales</div>

                        <div class="progress-row">
                            <div class="progress-stat">
                                <div class="progress-stat-value">${totalSets}</div>
                                <div class="progress-stat-label">Sets</div>
                            </div>
                            <div class="progress-stat">
                                <div class="progress-stat-value">${totalCards}</div>
                                <div class="progress-stat-label">Cartes</div>
                            </div>
                            <div class="progress-stat">
                                <div class="progress-stat-value">${globalStats.totalSessions}</div>
                                <div class="progress-stat-label">Sessions</div>
                            </div>
                            <div class="progress-stat">
                                <div class="progress-stat-value">${globalStats.totalQuestionsAnswered}</div>
                                <div class="progress-stat-label">Questions</div>
                            </div>
                        </div>

                        <div class="progress-row" style="margin-top: 20px;">
                            <div class="progress-stat" style="flex: 2;">
                                <div class="progress-stat-label">Taux de RÃ©ussite Global</div>
                                <div class="progress-stat-value" style="color: ${globalStats.totalSuccessRate >= 70 ? 'var(--color-success)' : globalStats.totalSuccessRate >= 50 ? 'var(--color-warning)' : 'var(--color-danger)'};">${globalStats.totalSuccessRate}%</div>
                                <div class="progress-bar-container" style="margin-top: 10px;">
                                    <div class="progress-bar-fill" style="width: ${globalStats.totalSuccessRate}%; background: ${globalStats.totalSuccessRate >= 70 ? 'var(--color-success)' : globalStats.totalSuccessRate >= 50 ? 'var(--color-warning)' : 'var(--color-danger)'};"></div>
                                </div>
                                <div style="font-size: 12px; color: var(--color-text-light); margin-top: 5px;">
                                    ${globalStats.totalCorrectAnswers} / ${globalStats.totalQuestionsAnswered} rÃ©ponses correctes
                                </div>
                            </div>
                            <div class="progress-stat">
                                <div class="progress-stat-value" style="color: var(--color-danger);">${totalMistakes}</div>
                                <div class="progress-stat-label">Erreurs Ã  revoir</div>
                            </div>
                        </div>

                        <div class="progress-header" style="margin-top: 30px; margin-bottom: 20px;">ð DÃ©tails par Set</div>
                        ${this.sets.length === 0 ? '<p style="color: var(--color-text-light); text-align: center;">Aucun set crÃ©Ã©</p>' : ''}
                        ${this.sets.map(set => {
                    const setStats = this.getSetStats(set.id);
                    const successRate = setStats.successRate || 0;
                    const lastStudied = setStats.lastStudied
                        ? new Date(setStats.lastStudied).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' })
                        : 'Jamais';
                    return `
                                <div class="set-stats" style="margin-bottom: 15px; padding: 20px; background: var(--color-bg-secondary); border-radius: 12px;">
                                    <div class="set-stats-title" style="font-size: 16px; font-weight: 700; margin-bottom: 15px; color: var(--color-primary);">${this.escapeHtml(set.title)}</div>
                                    <div class="set-stats-grid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; text-align: center;">
                                        <div class="set-stat-item">
                                            <div class="set-stat-value" style="font-size: 20px; font-weight: 700;">${set.cards.length}</div>
                                            <div class="set-stat-label" style="font-size: 11px; color: var(--color-text-light);">Cartes</div>
                                        </div>
                                        <div class="set-stat-item">
                                            <div class="set-stat-value" style="font-size: 20px; font-weight: 700;">${setStats.sessions}</div>
                                            <div class="set-stat-label" style="font-size: 11px; color: var(--color-text-light);">Sessions</div>
                                        </div>
                                        <div class="set-stat-item">
                                            <div class="set-stat-value" style="font-size: 20px; font-weight: 700;">${setStats.questionsAnswered}</div>
                                            <div class="set-stat-label" style="font-size: 11px; color: var(--color-text-light);">Questions</div>
                                        </div>
                                        <div class="set-stat-item">
                                            <div class="set-stat-value" style="font-size: 20px; font-weight: 700; color: ${successRate >= 70 ? 'var(--color-success)' : successRate >= 50 ? 'var(--color-warning)' : 'var(--color-danger)'};">${successRate}%</div>
                                            <div class="set-stat-label" style="font-size: 11px; color: var(--color-text-light);">RÃ©ussite</div>
                                        </div>
                                        <div class="set-stat-item">
                                            <div class="set-stat-value" style="font-size: 20px; font-weight: 700; color: var(--color-danger);">${setStats.mistakes}</div>
                                            <div class="set-stat-label" style="font-size: 11px; color: var(--color-text-light);">Erreurs</div>
                                        </div>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: var(--color-text-light);">
                                        DerniÃ¨re rÃ©vision: ${lastStudied}
                                    </div>
                                </div>
                            `;
                }).join('')}

                        ${globalStats.totalSessions > 0 ? `
                        <div style="margin-top: 20px; text-align: center;">
                            <button onclick="app.resetStats()" class="btn btn-outline" style="font-size: 12px; padding: 8px 15px; opacity: 0.7;">ðï¸ RÃ©initialiser les statistiques</button>
                        </div>
                        ` : ''}

                        <div style="margin-top: 30px; padding-top: 30px; border-top: 2px solid var(--color-border);">
                            <div class="progress-header" style="margin-bottom: 20px;">ð Rappels de RÃ©vision</div>
                            <div class="reminder-section">
                                <div class="reminder-toggle">
                                    <div class="toggle-switch ${this.reminderEnabled ? 'active' : ''}" onclick="app.toggleReminder()">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <div class="reminder-info">
                                        <div class="reminder-label">Rappels ${this.reminderEnabled ? 'ActivÃ©s' : 'DÃ©sactivÃ©s'}</div>
                                        <div class="reminder-desc">â ï¸ L'application doit rester ouverte dans le navigateur pour recevoir les rappels</div>
                                    </div>
                                </div>

                                ${this.reminderEnabled ? `
                                <div style="margin-top: 20px;">
                                    <div style="font-weight: 600; margin-bottom: 10px; color: var(--color-text);">Mes rappels (${this.reminderTimes.length}/5) :</div>

                                    <div style="display: flex; flex-direction: column; gap: 10px;">
                                        ${this.reminderTimes.map((time, index) => `
                                            <div style="display: flex; align-items: center; gap: 10px; background: var(--color-bg-secondary); padding: 10px 15px; border-radius: 8px;">
                                                <span style="font-size: 20px;">â°</span>
                                                <input type="time" value="${time}" onchange="app.updateReminderTime(${index}, this.value)" style="padding: 8px; border: 1px solid var(--color-border); border-radius: 6px; font-size: 16px;">
                                                ${this.reminderTimes.length > 1 ? `
                                                    <button onclick="app.removeReminder('${time}')" style="background: var(--color-danger); color: white; border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer; font-size: 14px;">â</button>
                                                ` : ''}
                                            </div>
                                        `).join('')}
                                    </div>

                                    ${this.reminderTimes.length < 5 ? `
                                    <div style="margin-top: 15px; display: flex; gap: 10px; align-items: center;">
                                        <input type="time" id="newReminderTime" style="padding: 8px; border: 1px solid var(--color-border); border-radius: 6px; font-size: 16px;">
                                        <button onclick="app.addReminder()" class="btn btn-success" style="padding: 8px 15px;">+ Ajouter un rappel</button>
                                    </div>
                                    ` : ''}
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;

                container.innerHTML = progressHtml;
            },

            // Mettre Ã  jour les statistiques aprÃ¨s une session
            updateStats(questionsAnswered, correctAnswers) {
                if (!this.currentSetId) return;

                // Stats globales
                this.stats.totalSessions = (this.stats.totalSessions || 0) + 1;
                this.stats.totalQuestionsAnswered = (this.stats.totalQuestionsAnswered || 0) + questionsAnswered;
                this.stats.totalCorrectAnswers = (this.stats.totalCorrectAnswers || 0) + correctAnswers;

                // Stats par set
                if (!this.stats.sets) this.stats.sets = {};
                if (!this.stats.sets[this.currentSetId]) {
                    this.stats.sets[this.currentSetId] = {
                        sessions: 0,
                        questionsAnswered: 0,
                        correctAnswers: 0,
                        lastStudied: null
                    };
                }

                const setStats = this.stats.sets[this.currentSetId];
                setStats.sessions += 1;
                setStats.questionsAnswered += questionsAnswered;
                setStats.correctAnswers += correctAnswers;
                setStats.lastStudied = new Date().toISOString();

                this.saveToStorage();
            },

            getSetStats(setId) {
                const mistakesForSet = this.mistakeCards.filter(m => m.setId === setId);
                const setData = (this.stats.sets && this.stats.sets[setId]) || {
                    sessions: 0,
                    questionsAnswered: 0,
                    correctAnswers: 0,
                    lastStudied: null
                };

                const successRate = setData.questionsAnswered > 0
                    ? Math.round((setData.correctAnswers / setData.questionsAnswered) * 100)
                    : 0;

                return {
                    sessions: setData.sessions,
                    questionsAnswered: setData.questionsAnswered,
                    correctAnswers: setData.correctAnswers,
                    mistakes: mistakesForSet.length,
                    successRate: successRate,
                    lastStudied: setData.lastStudied
                };
            },

            getGlobalStats() {
                const totalSuccessRate = this.stats.totalQuestionsAnswered > 0
                    ? Math.round((this.stats.totalCorrectAnswers / this.stats.totalQuestionsAnswered) * 100)
                    : 0;

                return {
                    totalSessions: this.stats.totalSessions || 0,
                    totalQuestionsAnswered: this.stats.totalQuestionsAnswered || 0,
                    totalCorrectAnswers: this.stats.totalCorrectAnswers || 0,
                    totalSuccessRate: totalSuccessRate
                };
            },

            resetStats() {
                if (!confirm('RÃ©initialiser toutes les statistiques? Cette action est irrÃ©versible.')) {
                    return;
                }

                this.stats = {
                    totalSessions: 0,
                    totalQuestionsAnswered: 0,
                    totalCorrectAnswers: 0,
                    sets: {}
                };
                this.saveToStorage();
                this.renderHome();
            },

            // ========== CREATE/EDIT SET ==========
            resetCreateForm() {
                document.getElementById('setTitle').value = '';
                document.getElementById('setDescription').value = '';
                document.getElementById('flashcardsContainer').innerHTML = '';
                this.addFlashcardInput();
            },

            addFlashcardInput(term = '', definition = '') {
                const container = document.getElementById('flashcardsContainer');
                const id = Date.now() + Math.random();

                const html = `
                    <div class="flashcard-input" id="card-${id}">
                        <input type="text" placeholder="Terme" class="form-input" value="${this.escapeHtml(term)}" data-term>
                        <input type="text" placeholder="DÃ©finition" class="form-input" value="${this.escapeHtml(definition)}" data-definition>
                        <button class="btn btn-danger btn-small" type="button" onclick="document.getElementById('card-${id}').remove()">Supprimer</button>
                    </div>
                `;

                container.insertAdjacentHTML('beforeend', html);
            },

            saveSet() {
                const title = document.getElementById('setTitle').value.trim();
                const description = document.getElementById('setDescription').value.trim();

                if (!title) {
                    alert('Veuillez entrer un titre');
                    return;
                }

                const cardInputs = document.querySelectorAll('#flashcardsContainer .flashcard-input');
                const cards = [];

                cardInputs.forEach(input => {
                    const term = input.querySelector('[data-term]').value.trim();
                    const definition = input.querySelector('[data-definition]').value.trim();

                    if (term && definition) {
                        cards.push({ term, definition });
                    }
                });

                if (cards.length === 0) {
                    alert('Veuillez ajouter au moins une carte');
                    return;
                }

                if (this.currentSetId) {
                    const set = this.sets.find(s => s.id === this.currentSetId);
                    if (set) {
                        set.title = title;
                        set.description = description;
                        set.cards = cards;
                    }
                } else {
                    this.sets.push({
                        id: Date.now(),
                        title,
                        description,
                        cards,
                        createdAt: new Date().toISOString()
                    });
                }

                this.saveToStorage();
                this.showHome();
            },

            editSet(setId) {
                this.currentSetId = setId;
                const set = this.sets.find(s => s.id === setId);

                if (!set) return;

                document.getElementById('setTitle').value = set.title;
                document.getElementById('setDescription').value = set.description || '';
                document.getElementById('flashcardsContainer').innerHTML = '';

                set.cards.forEach(card => {
                    this.addFlashcardInput(card.term, card.definition);
                });

                this.switchScreen('createSetScreen');
            },

            deleteSet(setId) {
                if (confirm('Ãtes-vous sÃ»r de vouloir supprimer ce set?')) {
                    this.sets = this.sets.filter(s => s.id !== setId);
                    this.saveToStorage();
                    this.renderHome();
                }
            },

            // ========== IMPORT FUNCTIONALITY ==========
            showImportModal() {
                this.importSeparator = '\t';
                this.importedCards = [];
                document.getElementById('importTextarea').value = '';
                document.getElementById('importPreview').innerHTML = '';
                document.getElementById('importModal').classList.add('active');
            },

            closeImportModal() {
                document.getElementById('importModal').classList.remove('active');
            },

            setSeparator(separator, element) {
                this.importSeparator = separator;
                document.querySelectorAll('.separator-btn').forEach(btn => btn.classList.remove('active'));
                element.classList.add('active');
                this.updateImportPreview();
            },

            updateImportPreview() {
                const textarea = document.getElementById('importTextarea');
                const text = textarea.value.trim();
                const preview = document.getElementById('importPreview');

                if (!text) {
                    preview.innerHTML = '<div style="color: var(--color-text-light); font-size: 12px;">Aucune donnÃ©e Ã  afficher</div>';
                    return;
                }

                const lines = text.split('\n').filter(line => line.trim());
                const cards = [];

                lines.forEach(line => {
                    const parts = line.split(this.importSeparator).map(p => p.trim());
                    if (parts.length >= 2) {
                        cards.push({
                            term: parts[0],
                            definition: parts.slice(1).join(' ')
                        });
                    }
                });

                this.importedCards = cards;

                if (cards.length === 0) {
                    preview.innerHTML = '<div style="color: var(--color-danger); font-size: 12px;">â ï¸ Aucune paire valide dÃ©tectÃ©e</div>';
                    return;
                }

                preview.innerHTML = cards.map(card => `
                    <div class="preview-row">
                        <div class="preview-term">${this.escapeHtml(card.term.substring(0, 30))}</div>
                        <div class="preview-definition">${this.escapeHtml(card.definition.substring(0, 30))}${card.definition.length > 30 ? '...' : ''}</div>
                    </div>
                `).join('');

                preview.innerHTML += `<div style="padding: 8px; font-weight: 600; color: var(--color-primary); text-align: center;">${cards.length} carte${cards.length > 1 ? 's' : ''} dÃ©tectÃ©e${cards.length > 1 ? 's' : ''}</div>`;
            },

            importCards() {
                if (this.importedCards.length === 0) {
                    alert('Aucune carte valide Ã  importer');
                    return;
                }

                const container = document.getElementById('flashcardsContainer');
                this.importedCards.forEach(card => {
                    this.addFlashcardInput(card.term, card.definition);
                });

                this.closeImportModal();
                alert(`â ${this.importedCards.length} carte${this.importedCards.length > 1 ? 's' : ''} importÃ©e${this.importedCards.length > 1 ? 's' : ''} avec succÃ¨s!`);
            },

            // ========== STUDY SCREEN ==========
            updateStudyHeader() {
                const title = this.currentSetId ? this.currentSet.title : 'RÃ©vision Quotidienne';
                const count = this.cardsToStudy.length;
                document.getElementById('studySetTitle').textContent = title;
                document.getElementById('studyProgress').textContent = `${count} carte${count > 1 ? 's' : ''} Ã  rÃ©viser`;
            },

            switchMode(mode) {
                // ArrÃªter le jeu en cours si on quitte le mode game
                this.stopGame();
                this.stopBubbleGame();

                this.currentMode = mode;
                this.isFlipped = false;
                this.currentCardIndex = 0;
                this.learnedCards = {};
                this.testAnswers = {};
                this.writeAnswers = {};

                document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
                // Update active button
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    if (btn.onclick.toString().includes(`'${mode}'`)) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });


                document.querySelectorAll('.study-content').forEach(content => content.style.display = 'none');

                switch (mode) {
                    case 'cards':
                        this.showCardLimitModal('cards');
                        break;
                    case 'learn':
                        this.showCardLimitModal('learn');
                        break;
                    case 'write':
                        this.showCardLimitModal('write');
                        break;
                    case 'test':
                        this.showCardLimitModal('test');
                        break;
                    case 'game':
                        // Pas de modal pour le mode Match, on dÃ©marre directement
                        this.cardsToStudy = [...this.currentSet.cards].sort(() => Math.random() - 0.5);
                        this.resetGame();
                        document.getElementById('gameMode').style.display = 'block';
                        break;
                    case 'associer':
                        this.cardsToStudy = [...this.currentSet.cards].sort(() => Math.random() - 0.5);
                        this.showAssocierDifficultyModal();
                        document.getElementById('associerMode').style.display = 'block';
                        break;
                    case 'bulles':
                        this.cardsToStudy = [...this.currentSet.cards].sort(() => Math.random() - 0.5);
                        this.showBubbleDifficultyModal();
                        document.getElementById('bubbleMode').style.display = 'block';
                        break;
                    case 'mistakes':
                        this.renderMistakesMode();
                        document.getElementById('mistakesMode').style.display = 'block';
                        break;
                    case 'incorrect':
                        this.renderIncorrectMode();
                        document.getElementById('incorrectMode').style.display = 'block';
                        break;
                }
            },

            // ========== CARDS MODE ==========
            renderCardsMode() {
                this.updateFlashcard();
                this.updateCardCounter();
            },

            updateFlashcard() {
                if (!this.cardsToStudy || this.cardsToStudy.length === 0) return;

                const card = this.cardsToStudy[this.currentCardIndex];
                const flashcard = document.getElementById('mainFlashcard');
                const label = document.getElementById('flashcardLabel');
                const content = document.getElementById('flashcardContent');

                this.isFlipped = false;
                flashcard.classList.remove('flipped');
                label.textContent = 'TERME';
                content.textContent = card.term;
            },

            toggleFlashcard() {
                const flashcard = document.getElementById('mainFlashcard');
                const label = document.getElementById('flashcardLabel');
                const content = document.getElementById('flashcardContent');
                const card = this.cardsToStudy[this.currentCardIndex];

                this.isFlipped = !this.isFlipped;

                if (this.isFlipped) {
                    flashcard.classList.add('flipped');
                    label.textContent = 'DÃFINITION';
                    content.textContent = card.definition;
                    document.getElementById('wrongBtn').style.display = 'block';
                } else {
                    flashcard.classList.remove('flipped');
                    label.textContent = 'TERME';
                    content.textContent = card.term;
                    document.getElementById('wrongBtn').style.display = 'none';
                }
            },

            markAsError() {
                const card = this.cardsToStudy[this.currentCardIndex];
                if (!this.incorrectCards.includes(card.term)) {
                    this.incorrectCards.push(card.term);
                    this.addMistakeCard(card);
                }

                // Track this as an error for stats
                if (!this.sessionCardsResults) this.sessionCardsResults = {};
                this.sessionCardsResults[this.currentCardIndex] = false;

                this.nextCard();
            },

            nextCard() {
                // If not already marked as error, mark it as correct for stats
                if (!this.sessionCardsResults) this.sessionCardsResults = {};
                if (this.sessionCardsResults[this.currentCardIndex] === undefined) {
                    this.sessionCardsResults[this.currentCardIndex] = true;
                }

                if (this.currentCardIndex < this.cardsToStudy.length - 1) {
                    this.currentCardIndex++;
                    this.updateFlashcard();
                    this.updateCardCounter();
                    document.getElementById('wrongBtn').style.display = 'none';
                } else {
                    this.showCardsResults();
                }
            },

            showCardsResults() {
                const total = this.cardsToStudy.length;
                const correct = Object.values(this.sessionCardsResults || {}).filter(v => v === true).length;
                this.updateStats(total, correct);

                const percent = total > 0 ? Math.round((correct / total) * 100) : 0;

                const result = `
                    <div id="cardsResultModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                        <div style="background: white; padding: 50px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center; max-width: 400px; animation: scaleIn 0.3s ease;">
                            <div class="test-score" style="font-size: 60px; margin-bottom: 20px;">${percent >= 70 ? 'ð' : 'ð'}</div>
                            <h2 style="color: var(--color-primary); margin-bottom: 20px; font-size: 28px;">Session terminÃ©e!</h2>
                            <p style="margin: 15px 0; font-size: 18px; color: var(--color-text);">â Score: <strong>${correct}/${total}</strong> (${percent}%)</p>
                            <div style="display: flex; gap: 10px; margin-top: 30px;">
                                <button class="btn btn-primary" style="flex: 1;" onclick="document.getElementById('cardsResultModal').remove(); app.switchMode('cards');">Rejouer</button>
                                <button class="btn btn-secondary" style="flex: 1;" onclick="document.getElementById('cardsResultModal').remove(); app.showHome();">Accueil</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', result);
            },

            previousCard() {
                if (this.currentCardIndex > 0) {
                    this.currentCardIndex--;
                    this.updateFlashcard();
                    this.updateCardCounter();
                }
            },

            updateCardCounter() {
                const total = this.cardsToStudy.length;
                document.getElementById('cardCounter').textContent = `${this.currentCardIndex + 1}/${total}`;
            },

            // ========== LEARN MODE ==========
            renderLearnMode() {
                const container = document.getElementById('learnContainer');
                const card = this.cardsToStudy[this.currentCardIndex];
                const options = this.generateQuizOptions(card);

                const progressPercent = (this.currentCardIndex / this.cardsToStudy.length) * 100;

                container.innerHTML = `
                    <div class="quiz-progress-bar">
                        <div class="quiz-progress-fill" style="width: ${progressPercent}%"></div>
                    </div>

                    <div class="quiz-question">Question ${this.currentCardIndex + 1}/${this.cardsToStudy.length} - Quelle est la dÃ©finition?</div>
                    <div class="quiz-question" style="font-size: 16px; color: var(--color-primary);">"${this.escapeHtml(card.term)}"</div>

                    <div class="quiz-options">
                        ${options.map((opt, idx) => `
                            <button class="quiz-option" onclick="app.handleLearnAnswer(${idx}, '${opt === card.definition}')">${this.escapeHtml(opt)}</button>
                        `).join('')}
                    </div>
                `;
            },

            handleLearnAnswer(idx, isCorrect) {
                const options = document.querySelectorAll('.quiz-option');
                const card = this.cardsToStudy[this.currentCardIndex];

                options.forEach((opt, i) => {
                    opt.style.pointerEvents = 'none';
                    if (i === idx) {
                        opt.classList.add(isCorrect === 'true' ? 'correct' : 'incorrect');
                    } else if (isCorrect === 'false') {
                        if (opt.textContent === card.definition) {
                            opt.classList.add('correct');
                        }
                    }
                });

                if (isCorrect === 'false' && !this.incorrectCards.includes(card.term)) {
                    this.incorrectCards.push(card.term);
                    this.addMistakeCard(card);
                }

                setTimeout(() => {
                    if (this.currentCardIndex < this.cardsToStudy.length - 1) {
                        this.currentCardIndex++;
                        this.renderLearnMode();
                    } else {
                        this.showLearnResults();
                    }
                }, 1500);
            },

            showLearnResults() {
                const container = document.getElementById('learnContainer');
                const total = this.cardsToStudy.length;
                const incorrect = this.incorrectCards.length;
                const correct = total - incorrect;
                const percent = total > 0 ? Math.round((correct / total) * 100) : 0;

                // Enregistrer les statistiques
                this.updateStats(total, correct);

                let incorrectButton = '';
                if (incorrect > 0) {
                    incorrectButton = `<button class="btn btn-danger" onclick="app.switchMode('incorrect')" style="margin-top: 15px;">â RÃ©viser les ${incorrect} erreur${incorrect > 1 ? 's' : ''}</button>`;
                }
                container.innerHTML = `
                    <div class="test-results">
                        <div class="test-score">${percent >= 70 ? 'ð' : percent >= 50 ? 'ð' : 'ðª'} ${percent}%</div>
                        <div class="test-stats">
                            <div class="stat-box">
                                <div class="stat-label">Correctes</div>
                                <div class="stat-value">${correct}/${total}</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Erreurs</div>
                                <div class="stat-value">${incorrect}</div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="app.switchMode('learn')">Recommencer</button>
                        ${incorrectButton}
                    </div>
                `;
            },

            // ========== TEST MODE ==========
            renderTestMode() {
                if (this.currentCardIndex >= this.cardsToStudy.length) {
                    this.showTestResults();
                    return;
                }

                const container = document.getElementById('testContainer');
                const card = this.cardsToStudy[this.currentCardIndex];
                const options = this.generateQuizOptions(card);

                const progressPercent = ((this.currentCardIndex + 1) / this.cardsToStudy.length) * 100;

                container.innerHTML = `
                    <div class="quiz-progress-bar">
                        <div class="quiz-progress-fill" style="width: ${progressPercent}%"></div>
                    </div>

                    <div class="quiz-question">Question ${this.currentCardIndex + 1}/${this.cardsToStudy.length}</div>
                    <div class="quiz-question" style="font-size: 16px; color: var(--color-primary);">${this.escapeHtml(card.term)}</div>

                    <div class="quiz-options">
                        ${options.map((opt, idx) => `
                            <button class="quiz-option" onclick="app.handleTestAnswer(${idx}, '${opt === card.definition}')">${this.escapeHtml(opt)}</button>
                        `).join('')}
                    </div>
                `;
            },

            handleTestAnswer(idx, isCorrect) {
                const options = document.querySelectorAll('.quiz-option');
                const card = this.cardsToStudy[this.currentCardIndex];

                this.testAnswers[this.currentCardIndex] = { isCorrect: isCorrect === 'true', selected: idx };

                if (isCorrect === 'false' && !this.incorrectCards.includes(card.term)) {
                    this.incorrectCards.push(card.term);
                    this.addMistakeCard(card);
                }

                options.forEach((opt, i) => {
                    opt.style.pointerEvents = 'none';
                    if (i === idx) {
                        opt.classList.add(isCorrect === 'true' ? 'correct' : 'incorrect');
                    } else if (isCorrect === 'false') {
                        if (opt.textContent === card.definition) {
                            opt.classList.add('correct');
                        }
                    }
                });

                setTimeout(() => {
                    this.currentCardIndex++;
                    this.renderTestMode();
                }, 1500);
            },

            showTestResults() {
                const container = document.getElementById('testContainer');
                const correct = Object.values(this.testAnswers).filter(a => a.isCorrect).length;
                const total = this.cardsToStudy.length;
                const percent = total > 0 ? Math.round((correct / total) * 100) : 0;

                // Enregistrer les statistiques
                this.updateStats(total, correct);

                let incorrectButton = '';
                if (this.incorrectCards.length > 0) {
                    incorrectButton = `<button class="btn btn-danger" onclick="app.switchMode('incorrect')" style="margin-top: 15px;">â RÃ©viser les ${this.incorrectCards.length} erreur${this.incorrectCards.length > 1 ? 's' : ''}</button>`;
                }

                container.innerHTML = `
                    <div class="test-results">
                        <div class="test-score">${percent >= 70 ? 'ð' : percent >= 50 ? 'ð' : 'ðª'} ${percent}%</div>
                        <div class="test-stats">
                            <div class="stat-box">
                                <div class="stat-label">Correctes</div>
                                <div class="stat-value">${correct}/${total}</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Erreurs</div>
                                <div class="stat-value">${this.incorrectCards.length}</div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="app.switchMode('test')">Recommencer le Test</button>
                        ${incorrectButton}
                        <button class="btn btn-secondary" style="margin-top: 15px;" onclick="app.showHome()">â Retour Ã  l'accueil</button>
                    </div>
                `;
            },

            // ========== GAME MODE ==========
            gameCardsCount: 6,

            stopGame() {
                // ArrÃªter le chrono en cours
                if (this.gameTimerInterval) {
                    clearInterval(this.gameTimerInterval);
                    this.gameTimerInterval = null;
                }
                this.gameActive = false;
            },

            resetGame() {
                // ArrÃªter tout chrono existant
                this.stopGame();

                this.gameMatched = [];
                this.gameSelected = [];
                this.gameScore = 0;
                this.currentGameCards = [];
                this.gameErrors = 0; // Reset game errors

                const startBtn = document.getElementById('startGameBtn');
                const quitBtn = document.getElementById('quitGameBtn');
                const board = document.getElementById('gameBoard');
                const timer = document.getElementById('gameTimer');
                const score = document.getElementById('gameScore');

                if (startBtn) startBtn.style.display = 'block';
                if (quitBtn) quitBtn.style.display = 'none';
                if (board) board.style.display = 'none';
                if (timer) timer.textContent = 'PrÃªt?';
                if (score) score.textContent = 'Matchs trouvÃ©s: 0/6';
            },

            quitGame() {
                if (confirm('Quitter le match en cours?')) {
                    this.resetGame();
                }
            },

            startGame() {
                // ArrÃªter tout chrono existant d'abord
                this.stopGame();

                this.gameMatched = [];
                this.gameSelected = [];
                this.gameScore = 0;
                this.gameActive = true;
                this.gameErrors = 0; // Reset game errors for new game

                document.getElementById('startGameBtn').style.display = 'none';
                document.getElementById('quitGameBtn').style.display = 'inline-flex';
                document.getElementById('gameBoard').style.display = 'grid';

                this.renderGameBoard();
                this.startGameTimer();
            },

            renderGameBoard() {
                const board = document.getElementById('gameBoard');

                // SÃ©lectionner 6 cartes alÃ©atoires parmi cardsToStudy
                const shuffledCards = [...this.cardsToStudy].sort(() => Math.random() - 0.5);
                const selectedCards = shuffledCards.slice(0, Math.min(this.gameCardsCount, shuffledCards.length));
                this.currentGameCards = selectedCards;

                const gameCards = [];

                selectedCards.forEach((card, index) => {
                    const uniqueId = index;
                    gameCards.push({
                        id: `term-${uniqueId}`,
                        text: card.term,
                        match: `def-${uniqueId}`,
                        type: 'term',
                        originalCard: card // Store original card for mistake tracking
                    });
                    gameCards.push({
                        id: `def-${uniqueId}`,
                        text: card.definition,
                        match: `term-${uniqueId}`,
                        type: 'definition',
                        originalCard: card // Store original card for mistake tracking
                    });
                });

                // MÃ©langer les 12 cartes
                gameCards.sort(() => Math.random() - 0.5);

                board.innerHTML = gameCards.map((card, idx) => `
                    <div class="game-card" onclick="app.selectGameCard('${card.id}', '${card.match}', ${idx})" data-id="${card.id}" data-match="${card.match}" data-index="${idx}">
                        ${this.escapeHtml(card.text)}
                    </div>
                `).join('');

                document.getElementById('gameScore').textContent = `Matchs trouvÃ©s: 0/${selectedCards.length}`;
            },

            selectGameCard(cardId, matchId, cardIndexInGameCards) {
                if (!this.gameActive || this.gameMatched.includes(cardId)) return;

                const cardElement = document.querySelector(`[data-id="${cardId}"]`);

                // Si la carte est dÃ©jÃ  sÃ©lectionnÃ©e, la dÃ©sÃ©lectionner
                if (cardElement.classList.contains('selected')) {
                    cardElement.classList.remove('selected');
                    this.gameSelected = this.gameSelected.filter(s => s.cardId !== cardId);
                    return;
                }

                cardElement.classList.add('selected');
                this.gameSelected.push({ cardId, matchId, cardIndexInGameCards });

                if (this.gameSelected.length === 2) {
                    const [first, second] = this.gameSelected;

                    if (first.matchId === second.cardId && second.matchId === first.cardId) {
                        // Bonne paire trouvÃ©e!
                        this.gameMatched.push(first.cardId, second.cardId);
                        this.gameScore++;
                        document.getElementById('gameScore').textContent = `Matchs trouvÃ©s: ${this.gameScore}/${this.currentGameCards.length}`;

                        const firstCardElement = document.querySelector(`[data-id="${first.cardId}"]`);
                        const secondCardElement = document.querySelector(`[data-id="${second.cardId}"]`);

                        // Animation de succÃ¨s puis disparition
                        firstCardElement.classList.remove('selected');
                        secondCardElement.classList.remove('selected');
                        firstCardElement.classList.add('correct-match');
                        secondCardElement.classList.add('correct-match');

                        setTimeout(() => {
                            firstCardElement.classList.add('matched');
                            secondCardElement.classList.add('matched');
                        }, 400);

                        this.gameSelected = [];

                        // VÃ©rifier si le jeu est terminÃ© (6 paires = 12 cartes)
                        if (this.gameMatched.length === this.currentGameCards.length * 2) {
                            setTimeout(() => this.endGame(), 500);
                        }
                    } else {
                        // Mauvaise paire
                        this.gameErrors = (this.gameErrors || 0) + 1;

                        // Add both cards to mistakes
                        // Need to find the original card object from currentGameCards based on the uniqueId part of cardId
                        const firstOriginalCardIndex = parseInt(first.cardId.split('-')[1]);
                        const secondOriginalCardIndex = parseInt(second.cardId.split('-')[1]);

                        const firstOriginalCard = this.currentGameCards[firstOriginalCardIndex];
                        const secondOriginalCard = this.currentGameCards[secondOriginalCardIndex];

                        if (firstOriginalCard) {
                            if (!this.incorrectCards.includes(firstOriginalCard.term)) {
                                this.incorrectCards.push(firstOriginalCard.term);
                                this.addMistakeCard(firstOriginalCard);
                            }
                        }
                        if (secondOriginalCard) {
                            if (!this.incorrectCards.includes(secondOriginalCard.term)) {
                                this.incorrectCards.push(secondOriginalCard.term);
                                this.addMistakeCard(secondOriginalCard);
                            }
                        }

                        setTimeout(() => {
                            document.querySelector(`[data-id="${first.cardId}"]`)?.classList.remove('selected');
                            document.querySelector(`[data-id="${second.cardId}"]`)?.classList.remove('selected');
                            document.querySelector(`[data-id="${first.cardId}"]`)?.classList.add('shake');
                            document.querySelector(`[data-id="${second.cardId}"]`)?.classList.add('shake');
                            setTimeout(() => {
                                document.querySelector(`[data-id="${first.cardId}"]`)?.classList.remove('shake');
                                document.querySelector(`[data-id="${second.cardId}"]`)?.classList.remove('shake');
                            }, 500);
                            this.gameSelected = [];
                        }, 400);
                    }
                }
            },

            addMistakeCard(card) {
                if (!this.mistakeCards) this.mistakeCards = [];
                const alreadyExists = this.mistakeCards.some(m => m.setId === this.currentSetId && m.term === card.term);
                if (!alreadyExists) {
                    this.mistakeCards.push({
                        setId: this.currentSetId,
                        term: card.term,
                        definition: card.definition,
                        addedAt: new Date().toISOString()
                    });
                    this.saveToStorage();
                }
            },

            startGameTimer() {
                let seconds = 0;
                this.gameTimerInterval = setInterval(() => {
                    if (!this.gameActive) {
                        clearInterval(this.gameTimerInterval);
                        return;
                    }
                    seconds++;
                    const mins = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    document.getElementById('gameTimer').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                }, 1000);
            },

            endGame() {
                this.stopGame();

                // Enregistrer les statistiques
                const totalPairs = this.currentGameCards.length;
                const totalActions = totalPairs + (this.gameErrors || 0);
                this.updateStats(totalActions, totalPairs);

                // Cacher le bouton quitter
                const quitBtn = document.getElementById('quitGameBtn');
                if (quitBtn) quitBtn.style.display = 'none';

                const errorInfo = this.gameErrors > 0 ? `<p style="margin: 10px 0; font-size: 16px; color: var(--color-danger);">â Erreurs: <strong>${this.gameErrors}</strong></p>` : '';

                const result = `
                    <div id="gameResultModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                        <div style="background: white; padding: 50px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center; max-width: 400px; animation: scaleIn 0.3s ease;">
                            <div class="test-score" style="font-size: 60px; margin-bottom: 20px;">ð</div>
                            <h2 style="color: var(--color-primary); margin-bottom: 20px; font-size: 28px;">Bravo!</h2>
                            <p style="margin: 15px 0; font-size: 18px; color: var(--color-text);">â±ï¸ Temps: <strong>${document.getElementById('gameTimer').textContent}</strong></p>
                            <p style="margin: 15px 0; font-size: 18px; color: var(--color-text);">â ${this.gameScore} paires trouvÃ©es</p>
                            ${errorInfo}
                            <div style="display: flex; gap: 10px; margin-top: 30px;">
                                <button class="btn btn-primary" style="flex: 1;" onclick="document.getElementById('gameResultModal').remove(); app.startGame();">Rejouer</button>
                                <button class="btn btn-secondary" style="flex: 1;" onclick="document.getElementById('gameResultModal').remove(); app.showHome();">Accueil</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', result);
            },

            // ========== MODE ASSOCIER (NEW) ==========
            showAssocierDifficultyModal() {
                document.getElementById('associerDifficultyModal').classList.add('active');
            },

            closeAssocierDifficultyModal() {
                document.getElementById('associerDifficultyModal').classList.remove('active');
            },

            selectAssocierDifficulty(lives) {
                this.associerInitialLives = lives;
                this.closeAssocierDifficultyModal();
                this.startAssocierGame();
            },

            selectAssocierCustomDifficulty() {
                const input = document.getElementById('associerCustomLives');
                const lives = parseInt(input.value);
                if (!lives || lives < 1) {
                    alert('Veuillez entrer un nombre de vies valide (minimum 1)');
                    return;
                }
                if (lives > 20) {
                    alert('Maximum 20 vies pour garder le plaisir du jeu !');
                    return;
                }
                this.selectAssocierDifficulty(lives);
            },

            startAssocierGame() {
                this.associerLives = this.associerInitialLives || 5;
                this.associerMatched = 0;
                this.associerTotalPairs = this.cardsToStudy.length; // Use cardsToStudy for total
                this.associerPairesPerManche = Math.min(5, this.associerTotalPairs);
                this.associerCurrentPaires = [];
                this.associerSelectedTerm = null;
                this.associerSelectedDef = null;
                this.associerErrors = 0;
                this.associerSuccesses = 0;
                this.associerPool = [...this.cardsToStudy];
                this.associerMatchedInManche = 0;

                this.updateLivesDisplay();
                this.clearAssocierLines();
                this.nextAssocierManche();
            },

            updateLivesDisplay() {
                const container = document.getElementById('livesContainer');
                if (!container) return;

                // Rendre les cÅurs dynamiquement
                let heartsHtml = '';
                for (let i = 0; i < this.associerInitialLives; i++) {
                    const isLost = i >= this.associerLives;
                    heartsHtml += `<span class="heart ${isLost ? 'lost' : ''}" data-idx="${i}">â¤ï¸</span>`;
                }
                container.innerHTML = heartsHtml;
            },

            nextAssocierManche() {
                if (this.associerPool.length === 0) {
                    this.endAssocierGame(true);
                    return;
                }

                // MÃ©langer le pool et prendre 5 paires
                const shuffledPool = [...this.associerPool].sort(() => Math.random() - 0.5);
                const count = Math.min(this.associerPairesPerManche, shuffledPool.length);
                this.associerCurrentPaires = shuffledPool.slice(0, count);

                this.renderAssocierGrid();
                this.updateAssocierProgress();
                this.clearAssocierLines();
            },

            updateAssocierProgress() {
                const totalText = `Paires: ${this.associerMatched}/${this.associerTotalPairs}`;
                document.getElementById('associerProgress').textContent = totalText;
            },

            renderAssocierGrid() {
                const leftCol = document.getElementById('associerLeftCol');
                const rightCol = document.getElementById('associerRightCol');
                if (!leftCol || !rightCol) return;

                const terms = this.associerCurrentPaires.map((p, i) => ({ text: p.term, id: i }));
                const defs = this.associerCurrentPaires.map((p, i) => ({ text: p.definition, id: i }));

                // MÃ©langer les colonnes diffÃ©remment
                terms.sort(() => Math.random() - 0.5);
                defs.sort(() => Math.random() - 0.5);

                leftCol.innerHTML = terms.map(t => `
                    <div class="associer-card" onclick="app.selectAssocierTerm(${t.id}, this)" data-type="term" data-id="${t.id}">
                        ${this.escapeHtml(t.text)}
                    </div>
                `).join('');

                rightCol.innerHTML = defs.map(d => `
                    <div class="associer-card" onclick="app.selectAssocierDef(${d.id}, this)" data-type="def" data-id="${d.id}">
                        ${this.escapeHtml(d.text)}
                    </div>
                `).join('');
            },

            selectAssocierTerm(id, el) {
                if (el.classList.contains('correct') || el.classList.contains('fade-out')) return;

                // DÃ©sÃ©lectionner le prÃ©cÃ©dent
                const prev = document.querySelector('#associerLeftCol .associer-card.selected');
                if (prev) prev.classList.remove('selected');

                this.associerSelectedTerm = { id, el };
                el.classList.add('selected');

                this.checkAssocierMatch();
            },

            selectAssocierDef(id, el) {
                if (el.classList.contains('correct') || el.classList.contains('fade-out')) return;

                // DÃ©sÃ©lectionner le prÃ©cÃ©dent
                const prev = document.querySelector('#associerRightCol .associer-card.selected');
                if (prev) prev.classList.remove('selected');

                this.associerSelectedDef = { id, el };
                el.classList.add('selected');

                this.checkAssocierMatch();
            },

            checkAssocierMatch() {
                if (!this.associerSelectedTerm || !this.associerSelectedDef) return;

                const term = this.associerSelectedTerm;
                const def = this.associerSelectedDef;

                if (term.id === def.id) {
                    this.handleAssocierSuccess(term, def);
                } else {
                    this.handleAssocierError(term, def);
                }

                this.associerSelectedTerm = null;
                this.associerSelectedDef = null;
            },

            handleAssocierSuccess(term, def) {
                this.associerMatched++;
                this.associerMatchedInManche++;
                this.associerSuccesses++;

                term.el.classList.remove('selected');
                def.el.classList.remove('selected');
                term.el.classList.add('correct');
                def.el.classList.add('correct');

                this.drawAssocierLine(term.el, def.el);
                this.updateAssocierProgress();

                // Retirer la carte du pool principal
                const matchedCard = this.associerCurrentPaires[term.id];
                this.associerPool = this.associerPool.filter(c => c.term !== matchedCard.term);

                setTimeout(() => {
                    term.el.classList.add('fade-out');
                    def.el.classList.add('fade-out');

                    setTimeout(() => {
                        this.nextAssocierManche();
                    }, 400);
                }, 800);
            },

            handleAssocierError(term, def) {
                this.associerLives--;
                this.associerErrors++;
                this.updateLivesDisplay();

                term.el.classList.remove('selected');
                def.el.classList.remove('selected');
                term.el.classList.add('wrong');
                def.el.classList.add('wrong');

                // Ajouter aux erreurs
                const cardData = this.associerCurrentPaires[term.id];
                this.addMistakeCard(cardData);

                setTimeout(() => {
                    term.el.classList.remove('wrong');
                    def.el.classList.remove('wrong');
                }, 400);

                if (this.associerLives === 0) {
                    setTimeout(() => this.endAssocierGame(false), 500);
                }
            },

            // ========== MODE BULLES (NEW) ==========
            showBubbleDifficultyModal() {
                document.getElementById('bubbleDifficultyModal').classList.add('active');
            },

            closeBubbleDifficultyModal() {
                document.getElementById('bubbleDifficultyModal').classList.remove('active');
            },

            setBubbleDifficulty(level, el) {
                this.bubbleDifficulty = level;
                document.querySelectorAll('#bubbleDifficultyModal .difficulty-btn').forEach(btn => btn.classList.remove('active'));
                el.classList.add('active');
            },

            setBubbleCount(count, el) {
                this.bubbleCount = count;
                document.querySelectorAll('#bubbleDifficultyModal .count-btn').forEach(btn => btn.classList.remove('active'));
                el.classList.add('active');
            },

            startBubbleGame() {
                this.bubbleScore = 0;
                this.bubbleErrors = 0;
                this.bubbleStartTime = Date.now();
                this.closeBubbleDifficultyModal();

                document.getElementById('bubbleScore').textContent = '0';
                document.getElementById('bubbleErrors').textContent = '0';

                this.startBubbleTimer();
                this.nextBubbleQuestion();
            },

            startBubbleTimer() {
                if (this.bubbleTimerInterval) clearInterval(this.bubbleTimerInterval);
                this.bubbleTimerInterval = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - this.bubbleStartTime) / 1000);
                    const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
                    const secs = (elapsed % 60).toString().padStart(2, '0');
                    document.getElementById('bubbleChrono').textContent = `${mins}:${secs}`;
                }, 1000);
            },

            nextBubbleQuestion() {
                if (this.bubbleGame) this.bubbleGame.stop();

                const area = document.getElementById('bubbleGameArea');
                area.innerHTML = '';

                // Choisir une question alÃ©atoire
                const correctCard = this.cardsToStudy[Math.floor(Math.random() * this.cardsToStudy.length)];
                this.bubbleCorrectCard = correctCard;
                document.getElementById('bubbleQuestion').textContent = correctCard.term;

                // GÃ©nÃ©rer les options
                const options = [correctCard.definition];
                const otherDefs = this.cardsToStudy
                    .filter(c => c.definition !== correctCard.definition)
                    .map(c => c.definition);

                while (options.length < this.bubbleCount && otherDefs.length > 0) {
                    const idx = Math.floor(Math.random() * otherDefs.length);
                    options.push(otherDefs.splice(idx, 1)[0]);
                }

                options.sort(() => Math.random() - 0.5);

                // CrÃ©ation du moteur physique
                this.bubbleGame = new BubblePhysics(area, options, correctCard.definition, (isCorrect, el) => {
                    if (isCorrect) {
                        this.bubbleScore++;
                        document.getElementById('bubbleScore').textContent = this.bubbleScore;
                        this.nextBubbleQuestion();
                    } else {
                        this.bubbleErrors++;
                        document.getElementById('bubbleErrors').textContent = this.bubbleErrors;
                        // Ne pas ajouter aux erreurs persistantes pour ce mode "Fun"
                    }
                }, this.bubbleDifficulty);

                this.bubbleGame.start();
            },

            stopBubbleGame() {
                if (this.bubbleGame) this.bubbleGame.stop();
                if (this.bubbleTimerInterval) clearInterval(this.bubbleTimerInterval);
            },

            drawAssocierLine(el1, el2) {
                const svg = document.getElementById('associerLines');
                const wrapper = document.querySelector('.associer-wrapper');
                if (!svg || !wrapper) return;

                const rect1 = el1.getBoundingClientRect();
                const rect2 = el2.getBoundingClientRect();
                const wRect = wrapper.getBoundingClientRect();

                const x1 = rect1.right - wRect.left;
                const y1 = rect1.top + rect1.height / 2 - wRect.top;
                const x2 = rect2.left - wRect.left;
                const y2 = rect2.top + rect2.height / 2 - wRect.top;

                const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const moveX = (x2 - x1) / 2;
                const d = `M ${x1} ${y1} C ${x1 + moveX} ${y1}, ${x2 - moveX} ${y2}, ${x2} ${y2}`;

                line.setAttribute('d', d);
                line.setAttribute('class', 'svg-line');
                svg.appendChild(line);

                // Disparition de la ligne aprÃ¨s l'animation
                setTimeout(() => {
                    line.style.opacity = '0';
                    line.style.transition = 'opacity 0.4s';
                    setTimeout(() => line.remove(), 400);
                }, 1000);
            },

            clearAssocierLines() {
                const svg = document.getElementById('associerLines');
                if (svg) svg.innerHTML = '';
            },

            endAssocierGame(isVictory) {
                // Enregistrer les statistiques
                this.updateStats(this.associerSuccesses + this.associerErrors, this.associerSuccesses);

                const percent = Math.round((this.associerSuccesses / (this.associerSuccesses + this.associerErrors)) * 100) || 0;

                const result = `
                    <div id="associerResultModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                        <div style="background: white; padding: 50px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center; max-width: 400px; animation: scaleIn 0.3s ease;">
                            <div class="test-score" style="font-size: 60px; margin-bottom: 20px;">${isVictory ? 'ð' : 'ð'}</div>
                            <h2 style="color: ${isVictory ? 'var(--color-success)' : 'var(--color-danger)'}; margin-bottom: 20px; font-size: 28px;">
                                ${isVictory ? 'Victoire !' : 'DÃ©faite...'}
                            </h2>
                            <p style="margin: 15px 0; font-size: 18px; color: var(--color-text);">ð PrÃ©cision: <strong>${percent}%</strong></p>
                            <p style="margin: 15px 0; font-size: 18px; color: var(--color-text);">â ${this.associerMatched} paires trouvÃ©es</p>
                            <p style="margin: 10px 0; font-size: 16px; color: var(--color-danger);">â Erreurs: <strong>${this.associerErrors}</strong></p>
                            <div style="display: flex; gap: 10px; margin-top: 30px;">
                                <button class="btn btn-primary" style="flex: 1;" onclick="document.getElementById('associerResultModal').remove(); app.startAssocierGame();">Rejouer</button>
                                <button class="btn btn-secondary" style="flex: 1;" onclick="document.getElementById('associerResultModal').remove(); app.showHome();">Accueil</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', result);
            },

            // ========== UTILITIES ==========
            generateQuizOptions(card) {
                const correct = card.definition;
                const options = [correct];

                const others = this.cardsToStudy
                    .filter(c => c.definition !== correct)
                    .map(c => c.definition)
                    .sort(() => Math.random() - 0.5)
                    .slice(0, 3);

                options.push(...others);
                options.sort(() => Math.random() - 0.5);

                return options;
            },

            // ========== INCORRECT MODE (Session Errors) ==========
            getIncorrectCardsData() {
                return this.incorrectCards.map(term => {
                    const card = this.currentSet.cards.find(c => c.term === term);
                    return card;
                }).filter(Boolean);
            },

            renderIncorrectMode() {
                const container = document.getElementById('incorrectContainer');

                if (this.incorrectCards.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">â</div>
                            <p>Aucune erreur dans cette session! Bravo! ð</p>
                            <button class="btn btn-primary" onclick="app.switchMode('cards')">Retour aux Cartes</button>
                        </div>
                    `;
                    return;
                }

                const incorrectData = this.getIncorrectCardsData();
                this.incorrectCardIndex = 0;
                this.incorrectFlipped = false;

                let html = `
                    <div class="flashcard-container">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <h2 style="color: var(--color-danger); margin-bottom: 10px;">â Erreurs de la session (${incorrectData.length})</h2>
                            <p style="color: var(--color-text-light); font-size: 14px;">RÃ©vise les cartes sur lesquelles tu t'es trompÃ© pendant cette session</p>
                        </div>
                        <div class="flashcard" id="incorrectFlashcard" onclick="app.toggleIncorrectFlashcard()">
                            <div class="flashcard-label" id="incorrectLabel">TERME</div>
                            <div class="flashcard-content" id="incorrectContent"></div>
                            <div class="flashcard-hint">Clique pour retourner la carte</div>
                        </div>
                    </div>

                    <div class="flashcard-controls">
                        <button class="btn btn-secondary" onclick="app.previousIncorrectCard()">â PrÃ©cÃ©dent</button>
                        <span style="padding: 10px; font-weight: 600;" id="incorrectCounter">1/${incorrectData.length}</span>
                        <button class="btn btn-secondary" onclick="app.nextIncorrectCard()">Suivant â</button>
                    </div>

                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-success" onclick="app.switchMode('learn')">ð Repasser le Test</button>
                    </div>
                `;

                container.innerHTML = html;
                this.updateIncorrectDisplay();
            },

            updateIncorrectDisplay() {
                const incorrectData = this.getIncorrectCardsData();
                if (!incorrectData || incorrectData.length === 0) return;

                const card = incorrectData[this.incorrectCardIndex];
                const flashcard = document.getElementById('incorrectFlashcard');
                const label = document.getElementById('incorrectLabel');
                const content = document.getElementById('incorrectContent');
                const counter = document.getElementById('incorrectCounter');

                this.incorrectFlipped = false;
                if (flashcard) flashcard.classList.remove('flipped');
                if (label) label.textContent = 'TERME';
                if (content) content.textContent = card.term;
                if (counter) counter.textContent = `${this.incorrectCardIndex + 1}/${incorrectData.length}`;
            },

            toggleIncorrectFlashcard() {
                const incorrectData = this.getIncorrectCardsData();
                if (!incorrectData || incorrectData.length === 0) return;

                const card = incorrectData[this.incorrectCardIndex];
                const flashcard = document.getElementById('incorrectFlashcard');
                const label = document.getElementById('incorrectLabel');
                const content = document.getElementById('incorrectContent');

                this.incorrectFlipped = !this.incorrectFlipped;

                if (this.incorrectFlipped) {
                    flashcard.classList.add('flipped');
                    label.textContent = 'DÃFINITION';
                    content.textContent = card.definition;
                } else {
                    flashcard.classList.remove('flipped');
                    label.textContent = 'TERME';
                    content.textContent = card.term;
                }
            },

            nextIncorrectCard() {
                const incorrectData = this.getIncorrectCardsData();
                if (this.incorrectCardIndex < incorrectData.length - 1) {
                    this.incorrectCardIndex++;
                    this.updateIncorrectDisplay();
                }
            },

            previousIncorrectCard() {
                if (this.incorrectCardIndex > 0) {
                    this.incorrectCardIndex--;
                    this.updateIncorrectDisplay();
                }
            },

            // ========== WRITE MODE ==========
            renderWriteMode() {
                if (this.currentCardIndex >= this.cardsToStudy.length) {
                    this.showWriteResults();
                    return;
                }

                const container = document.getElementById('writeContainer');
                const card = this.cardsToStudy[this.currentCardIndex];
                const progressPercent = ((this.currentCardIndex + 1) / this.cardsToStudy.length) * 100;

                container.innerHTML = `
                    <div class="quiz-progress-bar">
                        <div class="quiz-progress-fill" style="width: ${progressPercent}%"></div>
                    </div>

                    <div class="quiz-question">Question ${this.currentCardIndex + 1}/${this.cardsToStudy.length}</div>
                    <div class="quiz-question" style="font-size: 16px; color: var(--color-primary);">${this.escapeHtml(card.term)}</div>

                    <textarea id="writeAnswerInput" class="write-answer-input" placeholder="Ãcris ta rÃ©ponse ici..." autofocus></textarea>

                    <div class="write-controls">
                        <button class="btn btn-primary" onclick="app.submitWriteAnswer()">â Valider</button>
                        <button class="btn btn-secondary" onclick="app.skipWriteQuestion()" style="opacity: 0.7;">â Passer</button>
                    </div>
                `;

                setTimeout(() => {
                    document.getElementById('writeAnswerInput')?.focus();
                }, 100);
            },

            submitWriteAnswer() {
                const input = document.getElementById('writeAnswerInput');
                const userAnswer = input.value.trim();

                if (!userAnswer) {
                    alert('Veuillez Ã©crire une rÃ©ponse');
                    return;
                }

                const card = this.cardsToStudy[this.currentCardIndex];
                const resultType = this.checkAnswerSimilarity(userAnswer, card.definition);

                this.writeAnswers[this.currentCardIndex] = {
                    userAnswer,
                    correctAnswer: card.definition,
                    resultType,
                    term: card.term
                };

                this.showWriteAnswerFeedback(userAnswer, card.definition, resultType);
            },

            showWriteAnswerFeedback(userAnswer, correctAnswer, resultType) {
                const container = document.getElementById('writeContainer');
                const card = this.cardsToStudy[this.currentCardIndex];

                let feedbackClass = resultType;
                let feedbackTitle = '';
                let feedbackMessage = '';
                let showCorrectAnswer = true;
                let showValidationButton = false;

                if (resultType === 'correct') {
                    feedbackTitle = 'â Bonne rÃ©ponse!';
                    feedbackMessage = 'Votre rÃ©ponse est correcte!';
                    showCorrectAnswer = false;
                    showValidationButton = false;
                } else if (resultType === 'close') {
                    feedbackTitle = 'â ï¸ Presque juste!';
                    feedbackMessage = 'Votre rÃ©ponse est similaire, mais avec des diffÃ©rences d\'orthographe ou de formulation.';
                    showValidationButton = true;
                } else {
                    feedbackTitle = 'â Mauvaise rÃ©ponse';
                    feedbackMessage = 'Votre rÃ©ponse n\'est pas correcte. Voici la bonne rÃ©ponse:';
                    showValidationButton = true;
                }

                let html = `
                    <div class="quiz-progress-bar">
                        <div class="quiz-progress-fill" style="width: ${((this.currentCardIndex + 1) / this.cardsToStudy.length) * 100}%"></div>
                    </div>

                    <div class="quiz-question">Question ${this.currentCardIndex + 1}/${this.cardsToStudy.length}</div>

                    <div class="answer-feedback ${feedbackClass}">
                        <div class="answer-label">${feedbackTitle}</div>
                        <div>${feedbackMessage}</div>
                        ${showCorrectAnswer ? `<div class="correct-answer"><strong>RÃ©ponse correcte:</strong><br>${this.escapeHtml(correctAnswer)}</div>` : ''}
                    </div>

                    <div class="write-controls">
                        <button class="btn btn-success" onclick="app.acceptWriteAnswer()">â J'ai la bonne rÃ©ponse</button>
                        <button class="btn btn-primary" onclick="app.nextWriteQuestion()">Suivant â</button>
                    </div>
                `;

                if (resultType !== 'correct' && !this.incorrectCards.includes(card.term)) {
                    this.incorrectCards.push(card.term);
                    this.addMistakeCard(card);
                }

                container.innerHTML = html;
            },

            acceptWriteAnswer() {
                const answer = this.writeAnswers[this.currentCardIndex];
                if (answer) {
                    answer.resultType = 'correct';
                    if (this.incorrectCards.includes(answer.term)) {
                        this.incorrectCards = this.incorrectCards.filter(t => t !== answer.term);
                    }
                }
                this.nextWriteQuestion();
            },

            skipWriteQuestion() {
                const card = this.cardsToStudy[this.currentCardIndex];
                if (!this.incorrectCards.includes(card.term)) {
                    this.incorrectCards.push(card.term);
                }
                this.nextWriteQuestion();
            },

            nextWriteQuestion() {
                if (this.currentCardIndex < this.cardsToStudy.length - 1) {
                    this.currentCardIndex++;
                    this.renderWriteMode();
                } else {
                    this.showWriteResults();
                }
            },

            showWriteResults() {
                const container = document.getElementById('writeContainer');
                const total = this.cardsToStudy.length;
                const correct = Object.values(this.writeAnswers).filter(a => a.resultType === 'correct').length;
                const percent = total > 0 ? Math.round((correct / total) * 100) : 0;

                // Enregistrer les statistiques
                this.updateStats(total, correct);

                let incorrectButton = '';
                if (this.incorrectCards.length > 0) {
                    incorrectButton = `<button class="btn btn-danger" onclick="app.switchMode('incorrect')" style="margin-top: 15px;">â RÃ©viser les ${this.incorrectCards.length} erreur${this.incorrectCards.length > 1 ? 's' : ''}</button>`;
                }

                container.innerHTML = `
                    <div class="test-results">
                        <div class="test-score">${percent >= 70 ? 'ð' : percent >= 50 ? 'ð' : 'ðª'} ${percent}%</div>
                        <div class="test-stats">
                            <div class="stat-box">
                                <div class="stat-label">Correctes</div>
                                <div class="stat-value">${correct}/${total}</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Erreurs</div>
                                <div class="stat-value">${this.incorrectCards.length}</div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="app.switchMode('write')">Recommencer</button>
                        ${incorrectButton}
                        <button class="btn btn-secondary" style="margin-top: 15px;" onclick="app.showHome()">â Retour Ã  l'accueil</button>
                    </div>
                `;
            },

            // ========== CARD LIMIT MODAL ==========
            showCardLimitModal(mode) {
                this.currentMode = mode;
                document.getElementById('totalCardsCount').textContent = this.currentSet.cards.length;
                document.getElementById('cardLimitInput').value = '';
                document.getElementById('cardLimitModal').classList.add('active');
            },

            closeCardLimitModal() {
                document.getElementById('cardLimitModal').classList.remove('active');
            },

            startModeWithAllCards() {
                this.cardsToStudy = [...this.currentSet.cards].sort(() => Math.random() - 0.5);
                this.cardLimitForMode = null;
                this.closeCardLimitModal();
                this.startCurrentMode();
            },

            startModeWithLimit() {
                const input = document.getElementById('cardLimitInput');
                const limit = parseInt(input.value);

                if (!limit || limit < 1) {
                    alert('Veuillez entrer un nombre valide');
                    return;
                }

                if (limit > this.currentSet.cards.length) {
                    alert(`Vous ne pouvez pas sÃ©lectionner plus que ${this.currentSet.cards.length} cartes`);
                    return;
                }

                const shuffled = [...this.currentSet.cards].sort(() => Math.random() - 0.5);
                this.cardsToStudy = shuffled.slice(0, limit);
                this.cardLimitForMode = limit;
                this.closeCardLimitModal();
                this.startCurrentMode();
            },

            startCurrentMode() {
                this.currentCardIndex = 0;
                this.isFlipped = false;
                this.learnedCards = {};
                this.testAnswers = {};
                this.writeAnswers = {};
                this.incorrectCards = [];

                document.querySelectorAll('.study-content').forEach(content => content.style.display = 'none');

                switch (this.currentMode) {
                    case 'cards':
                        this.renderCardsMode();
                        document.getElementById('cardsMode').style.display = 'block';
                        break;
                    case 'learn':
                        this.renderLearnMode();
                        document.getElementById('learnMode').style.display = 'block';
                        break;
                    case 'write':
                        this.renderWriteMode();
                        document.getElementById('writeMode').style.display = 'block';
                        break;
                    case 'test':
                        this.renderTestMode();
                        document.getElementById('testMode').style.display = 'block';
                        break;
                    case 'game':
                        this.resetGame();
                        document.getElementById('gameMode').style.display = 'block';
                        break;
                }
            },

            // ========== MISTAKES TRACKING ==========
            addMistakeCard(card) {
                const exists = this.mistakeCards.find(m => m.setId === this.currentSetId && m.term === card.term);
                if (!exists) {
                    this.mistakeCards.push({
                        setId: this.currentSetId,
                        term: card.term,
                        definition: card.definition
                    });
                    this.saveToStorage();
                }
            },

            removeMistakeCard(setId, term) {
                this.mistakeCards = this.mistakeCards.filter(m => !(m.setId === setId && m.term === term));
                this.saveToStorage();
            },

            getMistakeCardsForSet(setId) {
                return this.mistakeCards.filter(m => m.setId === setId);
            },

            // ========== MISTAKES MODE ==========
            renderMistakesMode() {
                const container = document.getElementById('mistakesContainer');
                const mistakesForSet = this.getMistakeCardsForSet(this.currentSetId);

                if (mistakesForSet.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">â</div>
                            <p>Aucune erreur enregistrÃ©e</p>
                            <p style="font-size: 14px; color: var(--color-text-light);">Les cartes sur lesquelles tu fais des erreurs apparaÃ®tront ici</p>
                            <button class="btn btn-primary" onclick="app.switchMode('cards')" style="margin-top: 15px;">Retour aux Cartes</button>
                        </div>
                    `;
                    return;
                }

                this.mistakesCardIndex = 0;
                this.mistakesFlipped = false;

                let html = `
                    <div class="flashcard-container">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <h2 style="color: var(--color-danger); margin-bottom: 10px;">ð Mes Erreurs (${mistakesForSet.length})</h2>
                            <p style="color: var(--color-text-light); font-size: 14px;">RÃ©vise les cartes sur lesquelles tu t'es trompÃ©. Clique sur "J'ai mÃ©morisÃ©" pour retirer une carte.</p>
                        </div>
                        <div class="flashcard" id="mistakesFlashcard" onclick="app.toggleMistakesFlashcard()">
                            <div class="flashcard-label" id="mistakesLabel">TERME</div>
                            <div class="flashcard-content" id="mistakesContent"></div>
                            <div class="flashcard-hint">Clique pour retourner la carte</div>
                        </div>
                    </div>

                    <div class="flashcard-controls">
                        <button class="btn btn-secondary" onclick="app.previousMistakeCard()">â PrÃ©cÃ©dent</button>
                        <span style="padding: 10px; font-weight: 600;" id="mistakesCounter">1/${mistakesForSet.length}</span>
                        <button class="btn btn-secondary" onclick="app.nextMistakeCard()">Suivant â</button>
                    </div>

                    <div style="text-align: center; margin-top: 20px; gap: 10px; display: flex; flex-wrap: wrap; justify-content: center;">
                        <button class="btn btn-success" onclick="app.markMistakeAsLearned()" style="flex: 1; min-width: 200px;">â J'ai mÃ©morisÃ©!</button>
                        <button class="btn btn-danger" onclick="app.deleteMistakeCard()" style="flex: 1; min-width: 200px;">ðï¸ Supprimer</button>
                    </div>
                `;

                container.innerHTML = html;
                this.updateMistakesDisplay();
            },

            updateMistakesDisplay() {
                const mistakesForSet = this.getMistakeCardsForSet(this.currentSetId);
                if (!mistakesForSet || mistakesForSet.length === 0) return;

                const card = mistakesForSet[this.mistakesCardIndex];
                const flashcard = document.getElementById('mistakesFlashcard');
                const label = document.getElementById('mistakesLabel');
                const content = document.getElementById('mistakesContent');
                const counter = document.getElementById('mistakesCounter');

                this.mistakesFlipped = false;
                if (flashcard) flashcard.classList.remove('flipped');
                if (label) label.textContent = 'TERME';
                if (content) content.textContent = card.term;
                if (counter) counter.textContent = `${this.mistakesCardIndex + 1}/${mistakesForSet.length}`;
            },

            toggleMistakesFlashcard() {
                const mistakesForSet = this.getMistakeCardsForSet(this.currentSetId);
                if (!mistakesForSet || mistakesForSet.length === 0) return;

                const card = mistakesForSet[this.mistakesCardIndex];
                const flashcard = document.getElementById('mistakesFlashcard');
                const label = document.getElementById('mistakesLabel');
                const content = document.getElementById('mistakesContent');

                this.mistakesFlipped = !this.mistakesFlipped;

                if (this.mistakesFlipped) {
                    flashcard.classList.add('flipped');
                    label.textContent = 'DÃFINITION';
                    content.textContent = card.definition;
                } else {
                    flashcard.classList.remove('flipped');
                    label.textContent = 'TERME';
                    content.textContent = card.term;
                }
            },

            nextMistakeCard() {
                const mistakesForSet = this.getMistakeCardsForSet(this.currentSetId);
                if (this.mistakesCardIndex < mistakesForSet.length - 1) {
                    this.mistakesCardIndex++;
                    this.updateMistakesDisplay();
                }
            },

            previousMistakeCard() {
                if (this.mistakesCardIndex > 0) {
                    this.mistakesCardIndex--;
                    this.updateMistakesDisplay();
                }
            },

            markMistakeAsLearned() {
                const mistakesForSet = this.getMistakeCardsForSet(this.currentSetId);
                if (mistakesForSet.length === 0) return;

                const card = mistakesForSet[this.mistakesCardIndex];
                this.removeMistakeCard(this.currentSetId, card.term);

                // Ajuster l'index si nÃ©cessaire
                const newMistakes = this.getMistakeCardsForSet(this.currentSetId);
                if (this.mistakesCardIndex >= newMistakes.length) {
                    this.mistakesCardIndex = Math.max(0, newMistakes.length - 1);
                }

                this.renderMistakesMode();
            },

            deleteMistakeCard() {
                const mistakesForSet = this.getMistakeCardsForSet(this.currentSetId);
                if (mistakesForSet.length === 0) return;

                if (confirm('Supprimer cette carte des erreurs?')) {
                    const card = mistakesForSet[this.mistakesCardIndex];
                    this.removeMistakeCard(this.currentSetId, card.term);

                    // Ajuster l'index si nÃ©cessaire
                    const newMistakes = this.getMistakeCardsForSet(this.currentSetId);
                    if (this.mistakesCardIndex >= newMistakes.length) {
                        this.mistakesCardIndex = Math.max(0, newMistakes.length - 1);
                    }

                    this.renderMistakesMode();
                }
            },

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        };

        // Initialize app
        app.init();
    </script>
</body>

</html>